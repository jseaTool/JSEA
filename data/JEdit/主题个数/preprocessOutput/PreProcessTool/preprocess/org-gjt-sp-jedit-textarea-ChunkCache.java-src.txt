chunk cache intermediate layer between token list from token marker what on screen tab size 4 indent size 4 no tab collapse fold 1 2001 2005 g n u 2 w i t h o u t n y w r r n t y m e r h n t b i l i t y f i t n e s s f o r p r t i u l r p u r p o s e g n u g n u 59 330 m 02111 1307 u s textarea importsimport text tab expand buffer j edit buffer debug syntax log manage low level text display task visible line text area chunk cache contain an line info each line info associate one screen line text area contain information about line resize when text area geometry change chunk cache 24373 2016 05 05 03 02 43 chunk cache chunk cache constructor chunk cache text area text area text area text area out full list chunk out full physical line 1 token handler display token handler get max horizontal scroll width max line width textarea check all line line info max line width get max horizontal scroll width max 0 i 0 i line info length i++ line info info line info i info width max max info width max get screen line offset line physical line number document offset number character from left line screen line number where line offset are 1 position currently visible get screen line offset line offset line info length 0 1 line text area get first physical line 1 line text area get first physical line offset get line info 0 offset 1 line text area get last physical line 1 line last screen line p line info last get line info last screen line offset last offset offset last offset + last length last screen line screen line 1 find screen line contain offset i 0 n text area get visible line i n i++ line info info get line info i info physical line line line invisible? i 1 1 info physical line line offset info offset offset info offset + info length screen line i screen line 1 1 last screen line p line last screen line screen line screen line recalculate visible line recalculate visible line call when text area geometry change when font change recalculate visible line line info line info line info text area get visible line start line info start 0 start math min line info length line info length arraycopy line info 0 line info 0 start i start i line info length i++ line info i line info line info line info last screen line last screen line p 1 set buffer set buffer j edit buffer buffer buffer buffer last screen line last screen line p 1 scroll down scroll down amount visible line text area get visible line arraycopy line info amount line info 0 visible line amount i visible line amount i visible line i++ line info i line info first invalid line amount first invalid line 0 first invalid line 0 debug h u n k h e d e b u g err f t f only + amount + need update last screen line last screen line p 1 scroll up scroll up amount arraycopy line info 0 line info amount text area get visible line amount i 0 i amount i++ line info i line info t at home old first invalid line first invalid line first invalid line 0 update chunk up amount first invalid line old first invalid line + amount first invalid line text area get visible line first invalid line text area get visible line debug h u n k h e d e b u g log log log d e b u g f t f only + amount + need update last screen line last screen line p 1 invalidate all invalidate all first invalid line 0 last screen line last screen line p 1 reset invalidate all out full physical line 1 out full clear invalidate chunk from phy invalidate chunk from phy physical line physical line out full physical line out full physical line 1 i 0 i first invalid line i++ line info info line info i info physical line 1 || info physical line physical line first invalid line i i last screen line last screen line last screen line p 1 get line info line information given screen line non line info request screen line out range screen line screen line line info screen line line info get line info screen line screen line line info length line info update chunk up screen line line info screen line get line subregion count number subregion physical line physical line physical line number subregion physical line get line subregion count physical line text area soft wrap 1 line chunk list physical line size out full size size 0 1 size get subregion offset subregion contain specify offset subregion subset physical line each screen line correspond one subregion unlike link get screen line offset work non visible line too offset offset line info line info usualy result link get line info physical line call subregion offset 1 offset wa one given line info get subregion offset offset line info line info i 0 i line info length i++ line info info line info i offset info offset offset info offset + info length i 1 x subregion offset convert an x co ordinate within subregion into an offset from start subregion physical line physical line number subregion subregion 1 then last subregion x x co ordinate round round up next character x past middle character? offset from start subregion x subregion offset physical line subregion x round line info info get line info physical line physical line subregion 1 subregion + info length x subregion offset info subregion x round x subregion offset convert an x co ordinate within subregion into an offset from start subregion info line info x x co ordinate round round up next character x past middle character? offset from start subregion x subregion offset line info info x round offset chunk x offset info chunk x round offset 1 || offset info offset + info length offset info offset + info length 1 offset subregion offset x convert an offset within subregion into an x co ordinate physical line physical line offset offset x co ordinate offset within subregion subregion offset x physical line offset line info info get line info physical line physical line line info info info get subregion offset offset info subregion offset x info offset subregion offset x convert an offset within subregion into an x co ordinate info line info offset offset x co ordinate offset within subregion subregion offset x line info info offset chunk offset x info chunk offset get subregion start offset start offset specify subregion specify physical line line physical line number offset an offset start offset subregion line get subregion start offset line offset line info line info get line info physical line line line info info line info get subregion offset offset line info text area get line start offset info physical line + info offset get subregion end offset end offset specify subregion specify physical line line physical line number offset an offset end offset subregion line get subregion end offset line offset line info line info get line info physical line line line info info line info get subregion offset offset line info text area get line start offset info physical line + info offset + info length get below position physical line physical line number offset offset x location ignore wrap behave soft wrap off on get below position physical line offset x ignore wrap line info line info get line info physical line physical line subregion get subregion offset offset line info subregion line info length 1 ignore wrap text area get line start offset physical line + x subregion offset line info subregion + 1 x next line text area display get next visible line physical line next line 1 1 text area get line start offset next line + x subregion offset next line 0 x get above position physical line physical line number offset offset x location ignore wrap behave soft wrap off on get above position physical line offset x ignore wrap line info line info get line info physical line physical line subregion get subregion offset offset line info subregion 0 ignore wrap text area get line start offset physical line + x subregion offset line info subregion 1 x prev line text area display get prev visible line physical line prev line 1 1 text area get line start offset prev line + x subregion offset prev line 1 x need full repaint need full repaint variable become when number screen line physical line change text area need full repaint need full repaint ret val need full repaint need full repaint ret val get line info physical line line info get line info physical line physical line buffer loading line chunk list physical line physical line out full physical line list chunk chunk list out full empty chunk list list chunk chunk list add chunk list out full list line info value list line info chunk list size get line info physical line physical line value chunk list value line info chunk list size member instance variable text area text area j edit buffer buffer line info there line info each line visible text area resize link recalculate visible line content valid from 0 link first invalid line line info line info all chunk current physical line also link out full physical line chunk be create via call link line chunk list list chunk out full physical line number current tokeniz chunk line field contain 1 line wa tokeniz yet out full cache wa drop via link reset call also link out full out full physical line first invalid line all line before one are valid first invalid line last screen line p last screen line need full repaint display token handler token handler get line info physical line get line info physical line physical line list line info list list chunk chunk list out full physical line physical line i 0 i chunk list size i++ chunk chunk chunk list get i line info info line info info physical line physical line i 0 info first subregion info offset 0 info offset chunk offset i chunk list size 1 info last subregion info length text area get line length physical line info offset + 1 info length out full get i + 1 offset info offset info chunk chunk list add info get first screen line find valid line close last screen line get first screen line i first invalid line 1 i 0 i line info i last subregion i + 1 0 get update start line physical line number get update start line first screen line first line display take it physical line text area s first physical line first screen line 0 text area get first physical line otherwise determine next visible line prev phy line line info first screen line 1 physical line 1 empty space at end text area when buffer ha les line than are visible prev phy line 1 1 text area display get next visible line prev phy line update chunk up update chunk up last screen line nightmare last screen line line info length index out bound last screen line one line s chunk are invalid remain line are also invalid i e last screen line small first invalid screen line we t need update chunk leave here last screen line first invalid line first screen line get first screen line physical line get update start line first screen line debug h u n k h e d e b u g log log log d e b u g updating chunk from + first screen line + + last screen line below comment at least partly note we rely on fact when physical line invalidate all screen line subregion line are invalidate well below comment uphold assumption list chunk out list chunk 0 offset length i first screen line i last screen line i++ line info info line info i chunk chunk get another line chunk out empty unles first time increment line number physical line 1 i first screen line physical line text area display get next visible line physical line empty space physical line 1 info chunk info physical line 1 fix bug where horiz scroll bar wa update after create info width 0 chunk line line chunk list physical line out out full sub list 0 out full size info first subregion line ha no text out size 0 out empty i 0 text area display first line get skew 0 log log log e r r o r b u g skew + text area display first line get skew + out size + out size text area display first line set skew 0 need full repaint last screen line line info length 1 chunk offset 0 length 1 otherwise number subregion i 0 f i x m e i 0 ? i first line ? skew text area display first line get skew skew out size skew cannot great than chunk count line we need at least one chunk p subregion line log log log e r r o r b u g skew + skew + out size + out size need full repaint last screen line line info length 1 skew 0 info first subregion out out full sub list skew out full size chunk out get 0 out out sub list 1 out size offset chunk offset out empty length out get 0 offset offset length text area get line length physical line offset + 1 info first subregion chunk out get 0 out out sub list 1 out size offset chunk offset out empty length out get 0 offset offset length text area get line length physical line offset + 1 last subregion out empty i last screen line last screen line line info length 1 user change syntax token at end line need full repaint token handler get line context info line context last screen line++ need full repaint line ha become longer which physical line number different from cache one we need updating past last line advise text area repaint on other hand line wrap beyond last screen line we need keep updating chunk list ensure proper alignment invalidation flag start info physical line physical line || info last subregion last subregion last screen line++ need full repaint we only cache entire physical line at once t want split physical line into screen line only some valid out empty last screen line++ info physical line physical line info last subregion last subregion info offset offset info length length info chunk chunk info line context token handler get line context first invalid line math max last screen line + 1 first invalid line line chunk list chunk line fill out full chunk given physical line line chunk list physical line physical line 0 out full physical line physical line text area painter painter text area get painter tab expand expand text area get tab expand token handler init painter get style painter get font render context expand out full text area soft wrap ? text area wrap margin 0 0f buffer get line start offset physical line out full clear buffer mark token physical line token handler out full physical line physical line line info information on line fast access when using softwrap line divide n subregion line info physical line physical line 1 offset where begin line offset 0 line length length 0 first subregion line first subregion last subregion line last subregion chunk chunk line width width 0 token marker line context line context override line info + physical line + + offset + + length + + first subregion + + last subregion + 