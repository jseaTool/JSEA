buffer save request i o request tab size 4 indent size 4 no tab collapse fold 1 2000 2005 g n u 2 w i t h o u t n y w r r n t y m e r h n t b i l i t y f i t n e s s f o r p r t i u l r p u r p o s e g n u g n u 59 330 m 02111 1307 u s bufferio importsimport io io closeable zip io charset unsupport charset buffer save request buffer save request 24222 2015 12 11 23 27 42 buffer save request buffer i o request buffer save request constructor create buffer i o request view view buffer buffer session v f s session vf v f s path path buffer save request view view buffer buffer session v f s vf path view buffer session vf path run run v f s support rename we first save filename save then rename filename so save fail data lost 4 1pre7 we now call vf get two stage save name instead construct path directly since some v f s s might allow filename vf rename cap vf get capability v f s r e n m e p 0 want two stage want two stage save buffer two stage save vf rename cap want two stage vf get name path set status j edit get property vf status save entire save operation abort set cancellable original path path path vf canon path session path view misc utility u r l path path misc utility resolve symlink path save path two stage save save path vf get two stage save name path save path i o t get temporary path two stage save + path make backup save path path output stream out vf create output stream session save path view out buffer set property e r r o r o u r r e d must after stream create we deadlock s s h tool buffer read lock t use buffer get name here because change until save complete path end gz buffer set property buffer g i p p e d buffer get name end gz path end gz buffer name wa gz so mean s blabla txt gz blabla txt i remove gz property buffer set property buffer g i p p e d buffer get property buffer g i p p e d out g i p output stream out buffer out buffer read unlock interrupt e buffer set property e r r o r o u r r e d thread current thread interrupt i o utility close quietly closeable out two stage save make backup vf rename session save path path view i o rename fail + save path two stage save send original path let receiver resolve symlink necessary v f s send v f s update vf original path found e log log log e r r o r unable save buffer + e pp e get message v f s view path ioerror pp buffer set property e r r o r o u r r e d unsupport charset e log log log e r r o r e e pp e get charset name v f s view path ioerror unsupport encoding pp buffer set property e r r o r o u r r e d e log log log e r r o r e pp e v f s view path ioerror pp buffer set property e r r o r o u r r e d vf save complete session buffer path view two stage save vf finish two stage save session buffer path view clean up left over marker j edit get property persistent marker vf delete session buffer get marker path vf path view vf end v f s session session view e log log log e r r o r e pp e v f s view path ioerror pp buffer set property e r r o r o u r r e d member make backup make backup make backup only backup once p session buffer get property buffer b k e d u p || j edit get property backup every save j edit get property backup 1 0 vf backup session path view buffer set property buffer b k e d u p i o ioe backup failure shouldn t stop caller s activity like saving buffer so catching most backup failure are report directly backup less severity only rare manifest i o like 3574500 pp ioe get message v f s view path ioerror backup fail pp want two stage save want two stage save buffer buffer buffer get property forbid two stage save buffer get property overwrite readonly || j edit get property two stage save 