chunk syntax token extra information require painting on screen tab size 4 indent size 4 no tab collapse fold 1 2001 2002 g n u 2 w i t h o u t n y w r r n t y m e r h n t b i l i t y f i t n e s s f o r p r t i u l r p u r p o s e g n u g n u 59 330 m 02111 1307 u s syntax importsimport text font geom list list link hash map map ref soft reference debug i property syntax token extra information require painting on screen since j edit 4 1pre1 chunk token paint chunk list paint chunk list chunk chunk list gfx graphic context x x co ordinate y y co ordinate glyph vector we want use glyph vector we want use draw width paint text since j edit 4 2pre1 paint chunk list chunk chunk graphics2 d gfx x y glyph vector rectangle clip rect gfx get clip bound x 0 0f chunk only paint visible chunk x + x + chunk width clip rect x x + x clip rect x + clip rect width debug purpose debug h u n k p i n t d e b u g gfx draw rectangle2 d x + x y 10 chunk width 10 chunk accessible chunk glyph gfx set font chunk style get font gfx set color chunk style get foreground color glyph vector chunk draw glyph gfx x + x y chunk str gfx draw chunk str x + x y x + chunk width chunk chunk chunk next x paint chunk background paint background highlight chunk list chunk chunk list gfx graphic context x x co ordinate y y co ordinate width paint background since j edit 4 2pre1 paint chunk background chunk chunk graphics2 d gfx x y line height rectangle clip rect gfx get clip bound x 0 0f font metric background gfx get font metric ascent background get ascent height line height chunk only paint visible chunk x + x + chunk width clip rect x x + x clip rect x + clip rect width chunk accessible paint token background color necessary color bg color chunk background bg color gfx set color bg color gfx fill rectangle2 d x + x y ascent x + chunk width x height x + chunk width chunk chunk chunk next x offset x convert an offset chunk list into an x co ordinate chunk chunk list offset offset since j edit 4 1pre1 offset x chunk chunk offset chunk offset chunk offset index out bound offset + + chunk offset x 0 0f chunk chunk accessible offset chunk offset + chunk length x + chunk offset x offset chunk offset x + chunk width chunk chunk chunk next x x offset convert an x co ordinate chunk list into an offset chunk chunk list x x co ordinate round round up next letter past middle letter? offset within line 1 x co ordinate too far right since j edit 4 1pre1 x offset chunk chunk x round x 0 0f chunk chunk accessible x x + chunk width chunk x offset x x round x + chunk width chunk chunk chunk next 1 property change reload internal configuration base on given property prop configuration property since j edit 4 4pre1 property change i property prop font subst list prop font subst enable font subst font enable prefer font font subst enable parse prop get property view enable font subst font subst font enable parse prop get property view enable font subst font list font user font list font family i 0 prop family prop get property view font subst list + i font font d i l o g family doesn t match instal font following check skip font t font f font family font p l i n 12 dialog equal ignore f get family || dialog equal ignore family user font add f i++ prefer font user font font user font size clear cache hold reference old font which might become unus after property change glyph cache member instance variable syntax style style set up after init width chunk constructor construct virtual indent appear at beggin wrap line chunk width offset parser rule set rule token n u l l offset 0 rule width width accessible initialize chunk constructor chunk offset length parser rule set rule syntax style style offset length rule style style background style get background color background background style get background color accessible initialize chunk constructor chunk offset length parser rule set rule syntax style style color background offset length rule style style background background accessible initialize accessible chunk ha accesible text accessible length 0 initialize chunk ready painting initialize accessible virtual indent || glyph normal text || width 0 tab tab chunk represent tab tab segment line text length 1 line text line text offset + offset snippet before shorten uninitializ chunk before specific offset chunk snippet before snip offset 0 snip offset snip offset length chunk offset snip offset rule style background snippet after shorten uninitializ chunk after specific offset chunk snippet after snip offset 0 snip offset snip offset length chunk offset + snip offset length snip offset rule style background snippet before line offset shorten uninitializ chunk before specific offset offset line text instead chunk chunk snippet before line offset line offset snippet before line offset offset offset x offset x offset glyph 0 0f x 0 0f glyph vector gv glyph offset gv get num glyph x + gv get glyph position offset get x x x + gv get logical bound get width offset gv get num glyph shouldn t reach shouldn t reach 1 x offset x offset x round glyph round width x x offset + length offset off offset myx 0 0f glyph vector gv glyph gwidth gv get logical bound get width myx + gwidth x po gv get glyph position 0 gv get num glyph i 0 i gv get num glyph i++ glyph x myx + po i 1 next x i gv get num glyph 1 ? width myx + po i 1 + 2 next x x round || next x x x glyph x off + i off + i + 1 myx + gwidth off + gv get num glyph shouldn t reach shouldn t reach 1 init init segment line text tab expand expand x font render context font render context physical line offset accessible nothing tab line text x expand next tab stop x physical line offset+offset width x x str line text line text offset + offset length glyph key cache key glyph key str style get font font render context glyph cache cache get glyph cache glyph vector cache glyph cache get cache key cache glyph glyph cache glyph text start line text offset + offset text end text start + length glyph layout glyph style get font font render context line text text start text end cache put cache key glyph w 0 0f glyph vector gv glyph w + gv get logical bound get width width w initialize member variable e m p t y t e x t 0 font subst enable font subst font enable font prefer font font font subst list cache mean reduce call layout glyph vector which wa an outclass p u bottleneck profile on j profil sun j d k 6 window x p capacity roughly tune so effect clearly noticeable on very large random table mode like following table000 100 232 190 69 80 246 78 table000 100 69 84 206 160 197 161 table099 100 219 100 60 100 203 8 table100 100 159 189 159 76 9 239 additional heap usage lower than 1 m b heap usage wa measure about 400 k b 256 entry j r e 7u3 window x p glyph cache capacity 256 soft reference glyph cache glyph cache instance variable style get background color style get background color color background str glyph vector glyph get font subst list font get font subst list font subst list font subst font enable font font graphic environment get local graphic environment get all font font subst list font prefer font length + font length arraycopy prefer font 0 font subst list 0 prefer font length arraycopy font 0 font subst list prefer font length font length font subst list font prefer font length arraycopy prefer font 0 font subst list 0 prefer font length font subst list get subst font first font which display character from configure substitution candidate there no such font font get subst font codepoint workaround problem report s f net patch 3480246 font substitution font enable i get insert control character strange mathematical symbol from non unicode font my character i s o control codepoint font candidate get font subst list candidate display codepoint candidate draw glyph draw internal list glyph vector into given graphic gfx where draw glyph x starting horizontal position y vertical position draw glyph graphics2 d gfx x y glyph vector gv glyph gfx draw glyph vector gv x y x + gv get logical bound get width layout glyph vector wrapper font layout glyph vector simplify call glyph vector layout glyph vector font font font render context frc text start end f i x m e need bi di support flag font l y o u t l e f t t o r i g h t | font l y o u t n o s t r t o n t e x t | font l y o u t n o l i m i t o n t e x t glyph vector result font layout glyph vector frc text start end flag necessary work around memory leak sun 6 where sun font glyph layout cache reuse holding an instance font layout glyph vector frc e m p t y t e x t 0 0 flag result layout glyph layout glyph render given text apply font substitution configure font substitution work following manner all character render font character t handle font iterate over list available font find an appropriate one first match chosen user define his list prefer font which before font glyph vector layout glyph font font font render context frc text start end subst start font subst enable ? 1 font display up text start end subst start 1 glyph vector gv layout glyph vector font frc text start end glyph vector gv font substitution subst font substitution font frc text start subst add non subst range subst start start font substitution subst font text subst start end subst finish subst get glyph font substitution font substitution font substitution subst font font text start end start end next character point at text start count character count next font display next font subst font get subst font next subst font subst add range subst font count subst add non subst range count start + count start end next subst start font display up text start end next subst start 1 subst add non subst range end start subst add non subst range next subst start start start next subst start font substitution helper build glyph vector least call layout glyph vector no matter how many font substitution logic find intermediate boundary font substitution font substitution font font font render context frc text start font font frc frc text text range start start range font range length 0 glyph list glyph vector add non subst range length add range length add range font font length length 0 length 0 font range font range length + length add glyph vector last range range font font range start + range length range length length finish add glyph vector last range range font range start + range length range length 0 glyph vector get glyph glyph glyph vector glyph size font font font render context frc text range start font range font range length list glyph vector glyph add glyph vector last range range length 0 font font range font ? font range font derive font font get style font get size glyph vector gv layout glyph vector font frc text range start range start + range length glyph add gv get glyph cache glyph cache get glyph cache glyph cache glyph cache cache glyph cache get cache cache glyph cache one glyph cache glyph cache capacity glyph cache soft reference glyph cache one one glyph key glyph key token font font font render context context glyph key token font font font render context context token font context token token font font context context override hash token hash + font hash + context hash override equal other call only from glyph cache compare other key then type check check are necessary glyph key other glyph key other token equal other token font equal other font context equal other context override token glyph cache glyph cache link hash map glyph key glyph vector glyph cache capacity avoid rehash know limit capacity + 1 1 0f access order capacity capacity override remove eldest entry map entry glyph key glyph vector eldest size capacity capacity 