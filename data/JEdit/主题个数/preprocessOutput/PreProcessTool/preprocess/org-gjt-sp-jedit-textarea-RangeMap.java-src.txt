range map tab size 4 indent size 4 no tab collapse fold 1 2001 2005 g n u 2 w i t h o u t n y w r r n t y m e r h n t b i l i t y f i t n e s s f o r p r t i u l r p u r p o s e g n u g n u 59 330 m 02111 1307 u s textarea debug log fold visibility map all line from fvm 2 n fvm 2 n+1 1 inclusive are visible all line from position fvm 2 n+1 fvm 2 n+2 1 inclusive are invisible example all line visible 0 buffer get line count narrow from b b + 1 collapse fold from b 0 + 1 b buffer get line count note length alway range map range map constructor range map fvm 2 lastfvmget 1 range map constructor range map range map fvm fvm clone fvmcount fvmcount reset reset line lastfvmget 1 fvmcount 2 fvm 0 0 fvm 1 line first first fvm 0 last last fvm fvmcount 1 1 lookup lookup index fvm index search fold visibility map index given line search line line fvm 0 1 line fvm fvmcount 1 fvmcount 1 lastfvmget 1 line fvm lastfvmget lastfvmget fvmcount 1 || line fvm lastfvmget + 1 lastfvmget start 0 end fvmcount 1 loop end start 0 lastfvmget start loop 1 value fvm end value line lastfvmget end lastfvmget start loop pivot end + start 2 value fvm pivot value line lastfvmget pivot loop value line start pivot end pivot 1 lastfvmget put replace from start end 1 inclusive put update fvmcount put start end put debug f o l d v i s d e b u g builder buf builder 50 buf append fvmput append start append buf append end append buf append put i 0 i put length i++ i 0 buf append buf append put i buf append log log log d e b u g buf putl put ? 0 put length delta putl end start fvmcount + delta fvm length newfvm fvm length 1 + 1 arraycopy fvm 0 newfvm 0 fvmcount fvm newfvm delta 0 arraycopy fvm end fvm start + putl fvmcount end putl 0 arraycopy put 0 fvm start put length fvmcount + delta dump fvmcount 0 internal put2 merge previou next entry necessary put2 starti endi start end debug f o l d v i s d e b u g log log log d e b u g fvmput2 + starti + + endi + + start + + end + starti 1 fvm starti start endi fvmcount 2 fvm endi + 1 end + 1 put starti endi + 2 put starti endi + 1 end + 1 endi fvmcount 1 fvm endi + 1 end + 1 put starti + 1 endi + 2 start put starti + 1 endi + 1 start end + 1 next next line index search line collapse range index % 2 0 beyond last visible line fvmcount index + 1 1 start next expand range fvm index + 1 last expand range line fvm index + 1 1 equal last visible line fvmcount index + 2 1 start next expand range fvm index + 2 next expand range line + 1 prev prev line index search line before first visible line index 1 1 collapse range index % 2 1 end prev expand range fvm index 1 first expand range line fvm index equal first visible line index 0 1 end prev expand range fvm index 1 1 prev expand range line 1 show show start end starti search start endi search end starti % 2 0 endi % 2 0 put starti + 1 endi + 1 endi fvmcount 1 fvm endi + 1 end + 1 put starti + 1 endi + 2 put starti + 1 endi fvm starti + 1 end + 1 endi % 2 0 starti 1 fvm starti start put starti endi + 1 put starti + 1 endi fvm starti + 1 start put2 starti endi start end lastfvmget 1 hide hide start end starti search start endi search end starti % 2 0 endi % 2 0 put2 starti endi start end start fvm 0 put starti endi + 1 put starti + 1 endi fvm starti + 1 start endi % 2 0 end + 1 fvm fvmcount 1 put starti + 1 endi + 2 put starti + 1 endi fvm starti + 1 end + 1 put starti + 1 endi + 1 lastfvmget 1 count count fvmcount dump dump debug f o l d v i s d e b u g builder buf builder i 0 i fvmcount i++ i 0 buf append buf append fvm i buf append log log log d e b u g fvm + buf content insert content insert start line num line num line 0 index search start line start index + 1 i start i fvmcount i++ fvm i + num line lastfvmget 1 dump pre content remove anchor reset pre content remove start line num line value end line start line + num line update fold visibility map starti search start line endi search end line both same visibility just remove anyth between math ab starti % 2 math ab endi % 2 endi starti fvmcount we re remove from before first visible after last visible value starti 1 put starti + 1 endi + 1 starti++ collapse 2 starti 1 fvm starti start line endi starti fvmcount 1 we re remove from first visible after last visible value starti 1 put starti endi + 1 shift put starti + 1 endi fvm starti + 1 start line starti + 2 update i starti i fvmcount i++ fvm i num line lastfvmget 1 dump value member fvm fvmcount lastfvmget 