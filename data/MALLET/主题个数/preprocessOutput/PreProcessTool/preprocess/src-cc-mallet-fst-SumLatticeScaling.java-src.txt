io o io input stream io output stream io serializable logging level logging logger transducer transducer transition iterator type label alphabet type label vector type logger sum lattice scaling sum lattice logger logger logger get logger sum lattice scaling get name save xi ip input position op output position index suppres warning uncheck input output transducer t total weight lattice node node index ip alpha log scaling beta log scaling z log scaling lattice length gamma index ip xi index ip j save save xi ensure instance cannot easily create zero constructor sum lattice scaling lattice node get lattice node ip index node ip index node ip index lattice node ip t get index node ip index suppres warning uncheck sum lattice scaling transducer tran input tran input transducer incrementor save xi suppres warning uncheck sum lattice scaling transducer tran input save xi tran input transducer incrementor save xi suppres warning uncheck sum lattice scaling transducer tran input transducer incrementor incrementor tran input incrementor save xi suppres warning uncheck sum lattice scaling transducer tran input output tran input output transducer incrementor save xi you pas output meaning lattice constrain match output suppres warning uncheck sum lattice scaling transducer tran input output transducer incrementor incrementor tran input output incrementor save xi suppres warning uncheck sum lattice scaling transducer tran input output transducer incrementor incrementor label alphabet output alphabet tran input output incrementor save xi output alphabet you pas output meaning lattice constrain match output suppres warning uncheck sum lattice scaling transducer tran input output transducer incrementor incrementor save xi tran input output incrementor save xi suppres warning uncheck sum lattice scaling transducer tran input output transducer incrementor incrementor save xi label alphabet output alphabet output || input size output size initialize some structure t tran input input output output lattice length input size + 1 num t num node lattice node lattice length num alpha log scaling lattice length beta log scaling lattice length gamma lattice length num save xi xi lattice length num num output count output alphabet output count lattice length output alphabet size ip 0 ip lattice length ip++ alpha log scaling ip 0 0 beta log scaling ip 0 0 0 num i++ gamma ip transducer m p o l e w e g h t save xi j 0 j num j++ xi ip j transducer m p o l e w e g h t forward pas logger fine starting foward pas least 0 num i++ weight t get get weight weight transducer m p o l e w e g h t get lattice node 0 alpha math weight least rescale alpha 0 least logger warning there starting ip 0 ip lattice length 1 ip++ 0 num i++ node ip t get transition iterator it transition iterator input ip output ip it next destination it next lattice node destination node get lattice node ip + 1 destination get index na n destination node alpha destination node alpha 0 destination node output it get output transition weight it get weight destination node alpha + node ip alpha math transition weight re scale alpha \sum \alpha ip 1 rescale alpha ip + 1 calculate total weight lattice normalizer z na n 0 num i++ node lattice length 1 na n z z 0 z + node lattice length 1 alpha math t get get weight z log scaling alpha log scaling lattice length 1 na n z total weight transducer m p o l e w e g h t total weight math log z + z log scaling backward pas 0 num i++ node lattice length 1 t get node lattice length 1 beta math get weight gamma node lattice length 1 alpha node lattice length 1 beta z gamma lattice length 1 math log gamma incrementor p gamma p 0 0 p 1 0 + 1e 6 p + p + gamma + gamma lattice length 1 incrementor increment p rescale beta lattice length 1 ip lattice length 2 ip 0 ip 0 num i++ node ip t get transition iterator it transition iterator input ip output ip log scaling alpha log scaling ip + beta log scaling ip + 1 z log scaling pscal math log scaling it next destination it next j destination get index lattice node destination node node ip + 1 j destination node transition weight it get weight na n node ip beta node ip beta 0 transition prob math transition weight node ip beta + destination node beta transition prob xi node ip alpha transition prob node ip + 1 j beta z save xi xi ip j math log xi + log scaling incrementor || output alphabet p xi pscal p 0 0 p 1 0 + 1e 6 p + p + xi + ip + + + + j + + xi incrementor incrementor increment transition it p output alphabet output index output alphabet lookup index it get output output index 0 output count ip output index + p gamma ip math log node ip alpha node ip beta z + log scaling re scale beta they normalize rescale beta ip incrementor 0 num i++ p math gamma 0 p 0 0 p 1 0 + 1e 6 p + p incrementor increment t get p node ip node ip || na n node ip alpha rescale alpha ip sum alpha 0 0 t num i++ node ip sum alpha + node ip alpha sum alpha 0 sum over alpha ip + ip alpha log scaling ip math log sum alpha + ip 0 ? 0 alpha log scaling ip 1 0 t num i++ node ip node ip alpha sum alpha rescale beta ip sum beta 0 0 t num i++ node ip sum beta + node ip beta sum beta 0 sum over beta ip + ip beta log scaling ip math log sum beta + ip lattice length 1 ? 0 beta log scaling ip + 1 0 t num i++ node ip node ip beta sum beta get xi xi get gamma gamma get total weight total weight get gamma weight input position gamma input position get index get gamma weight input position index gamma input position index get gamma probability input position math gamma input position get index get gamma probability input position index get gamma probability input position t get index get xi probability ip s1 s2 math get xi weight ip s1 s2 get xi weight ip s1 s2 xi illegal xi be save s1 get index j s2 get index xi ip j length lattice length get alpha ip lattice node node get lattice node ip get index node alpha math alpha log scaling ip get beta ip lattice node node get lattice node ip get index node beta math beta log scaling ip label vector get label position output position runtime sum lattice scaling get input input transducer get transducer t lattice node input position output alpha na n beta na n lattice node input position input position input position factory sum lattice factory serializable suppres warning uncheck sum lattice sum lattice transducer tran input output transducer incrementor incrementor save xi label alphabet output alphabet sum lattice scaling tran input output incrementor save xi output alphabet serial u 1 u r r e n t e r l v e r o n 1 write output stream o write u r r e n t e r l v e r o n read input stream o found suppres warning unus read 