2002 univ dept part m l l e t m achine learning languag e toolkit 1 0 information see ` l e n e type gnu trove t hash gnu trove t hash map gnu trove t iterator io buffer writer io writer io o io print writer format collection type multinomial math random variou useful function dirichlet distribution mc callum david mimno dirichlet alphabet dict magnitude 1 partition random random actually negative euler mascheroni constant e u l e r m h e r o n 0 5772156649015328606065121 p q u r e o v e r math p math p 6 h l f l o g t w o p math log 2 math p 2 g m m o e f 1 1 12 g m m o e f 2 1 120 g m m o e f 3 1 252 g m m o e f 4 1 240 g m m o e f 5 1 132 g m m o e f 6 691 32760 g m m o e f 7 1 12 g m m o e f 8 3617 8160 g m m o e f 9 43867 14364 g m m o e f 10 174611 6600 g m m l r g e 9 5 g m m m l l 000001 dirichlet parameteriz magnitude m magnitude dirichlet sum alpha p probability p alpha m dirichlet m p magnitude m partition p symmetric dirichlet e e j j m magnitude dirichlet sum alpha n dimension dirichlet m n magnitude m partition n partition 0 1 0 n 1 n i++ partition partition 0 dirichlet parameteriz single vector positive real dirichlet p magnitude 0 partition p length add up total 0 p length i++ magnitude + p 0 p length i++ partition p magnitude constructor take alphabet represent meaning dimension dirichlet alpha alphabet dict alpha dict alpha length dict size illegal argument alpha dict size match dict dict dict dict stop growth symmetric dirichlet alpha 1 0 dimension alphabet dirichlet alphabet dict dict 1 0 symmetric dirichlet alpha alpha dimension alphabet dirichlet alphabet dict alpha dict size alpha dict dict dict stop growth symmetric dirichlet alpha 1 0 size dimension dirichlet size size 1 0 symmetric dirichlet e e j j n dimension alpha parameter dimension dirichlet size alpha magnitude size alpha partition size partition 0 1 0 size 1 size i++ partition partition 0 init random random random random next partition length init random dimension draw sample gamma mp 1 sum 0 0 length i++ random next gamma partition magnitude 1 0 0 0001 sum + normalize 0 length i++ sum printable alpha magnitude buffer output buffer format formatt format get instance formatt maximum fraction digit 5 output append formatt format magnitude + 0 length i++ output append formatt format + output write alpha specify line filename o print writer print writer buffer writer writer filename 0 partition length i++ magnitude partition flush close dirichlet multinomial draw dirichlet draw n sample multinomial draw observation n init random next draw observation n draw count vector probability n expect total count vector poisson n draw observation n init random histogram partition length fill histogram 0 count poisson poisson variate generator go berzerk lambda 500 n 100 count random next poisson p n 100 10 0 7 619853e 24 count math round random next gaussian n n 0 count i++ histogram random next discrete ++ histogram draw dirichlet multinomial average n observation draw observation n observation 0 i++ observation draw observation n observation calculate log gamma function exactly extremely inefficient comparison log gamma definition z e u l e r m h e r o n z math log z k 1 k 10000000 k++ + z k math log 1 + z k directly calculate difference between two log gamma function recursive formula stirl approximation about n 2 worth log gamma difference z n 0 0 0 n i++ + math log z + currently alias log gamma stirl log gamma z log gamma stirl z fifth stirl approximation z note stirl approximation increasingly unstable z approach 0 z les 2 we shift up calculate approximation shift answer back down log gamma stirl z shift 0 z 2 z++ shift++ h l f l o g t w o p + z 0 5 math log z z + 1 12 z 1 360 z z z + 1 1260 z z z z z shift 0 shift z math log z gergo neme approximation log gamma neme z h l f l o g t w o p math log z 2 + z math log z + 1 12 z 1 10 z 1 calculate digamma asymptotic expansion involve bernoulli number digamma z matlab tom minka z 0 les zero psi 0 z g m m m l l psi e u l e r m h e r o n 1 z + p q u r e o v e r z n 1 n 100000 n++ psi + z n n + z psi z g m m l r g e psi 1 z z++ inv z 1 z inv z square inv z inv z psi + math log z 5 inv z inv z square g m m o e f 1 inv z square g m m o e f 2 inv z square g m m o e f 3 inv z square g m m o e f 4 inv z square g m m o e f 5 inv z square g m m o e f 6 inv z square g m m o e f 7 psi digamma difference n sum 0 0 n i++ sum + 1 + sum trigamma z shift 0 z 2 z++ shift++ over z 1 0 z over z square over z over z over z + 0 5 over z square + 0 1666667 over z square over z 0 03333333 over z square over z square over z + 0 02380952 over z square over z square over z square over z 0 03333333 over z square over z square over z square over z square over z shift 0 shift z + 1 0 z z learn concentration parameter symmetric dirichlet frequency histogram since same we need keep track observation dimension pair count n count histogram frequency matrix observation sub sub many time word t occur document count histogram 3 total cell column equal 3 observation length histogram sample length observation length 20 could document exactly 20 num dimension total dimension current value starting value learn symmetric concentration count histogram observation length num dimension current value current digamma histogram presumably allocate we know what go them likely large zero value much closer beginning we t want iterate over whole bunch zero keep track last value large zero count 0 zero length index observation length length index 0 index count histogram length index++ count histogram index 0 large zero count index dense index 0 index 0 index observation length length index++ observation length index 0 zero length index dense index index dense index++ dense index size dense index iteration 1 iteration 200 iteration++ current parameter current value num dimension calculate numerator current digamma 0 numerator 0 count 0 t matter start 1 index 1 index large zero count index++ current digamma + 1 0 current parameter + index 1 numerator + count histogram index current digamma now calculate denominator sum over observation length current digamma 0 denominator 0 previou length 0 cache digamma digamma current value dense index 0 dense index dense index size dense index++ length zero length index dense index length previou length 20 next length sufficiently far previou fast recalculate scratch current digamma digamma current value + length cache digamma iterate up look slightly different previou 1 because we re indexing differently index previou length index length index++ current digamma + 1 0 current value + index denominator + current digamma observation length length current value current parameter numerator denominator current value + + current parameter + + numerator + + denominator current value test symmetric concentration num dimension num observation observation length log math log num dimension exponent 5 exponent 4 exponent++ alpha num dimension 1 0 dirichlet prior dirichlet num dimension alpha num dimension count histogram 1000000 observation length 1000000 observation prior draw observation num observation observation length dirichlet optimize dirichlet dirichlet num dimension 1 0 optimize dirichlet learn histogram observation optimize dirichlet magnitude 0 num observation i++ observation observation total 0 k 0 k num dimension k++ observation k 0 total + observation k count histogram observation k ++ observation length total ++ estimate alpha learn symmetric concentration count histogram observation length num dimension 1 0 alpha + + estimate alpha + + math ab alpha estimate alpha learn dirichlet frequency histogram reference current value update place observation count histogram observation 10 3 could document contain exactly 3 word type 10 observation length histogram sample length observation length 20 could document exactly 20 sum learn learn observation observation length learn observation observation length 1 00001 1 0 200 learn dirichlet frequency histogram reference current value update place observation count histogram observation 10 3 could document contain exactly 3 word type 10 observation length histogram sample length observation length 20 could document exactly 20 shape gamma prior e shape scale var shape scale sup 2 sup scale num iteration 200 1000 generally insure convergence 1 5 often enough step direction sum learn learn observation observation length shape scale num iteration k sum 0 initialize parameter sum k 0 k length k++ sum + k old k current digamma denominator zero limit zero limit observation length fill zero limit 1 histogram go up size large document zero value almost cluster low we looping over empty saving index large zero value histogram 0 observation length i++ histogram observation buffer buffer k 0 k histogram length k++ histogram k 0 zero limit k append k + + histogram k + iteration 0 iteration num iteration iteration++ calculate denominator denominator 0 current digamma 0 iterate over histogram 1 observation length length i++ current digamma + 1 sum + 1 denominator + observation length current digamma bayesian estimation part denominator 1 scale calculate individual sum 0 k 0 k length k++ what large zero element histogram? zero limit zero limit k old k k k 0 current digamma 0 histogram observation k 1 zero limit i++ current digamma + 1 old k + 1 k + histogram current digamma bayesian estimation part k old k k + shape denominator sum + k sum 0 0 runtime sum + sum sum fix point iteration describe tom minka learn histogram observation max length 0 max bin count partition length fill max bin count 0 0 observation length i++ length 0 observation observation bin 0 bin observation length bin++ observation bin max bin count bin max bin count bin observation bin length + observation bin length max length max length length start zero m sacrifice great clarity late bin count histogram partition length bin 0 bin partition length bin++ bin count histogram bin max bin count bin + 1 fill bin count histogram bin 0 get mem + current milli start length histogram max length + 1 fill length histogram 0 get length + current milli start 0 observation length i++ length 0 observation observation bin 0 bin observation length bin++ bin count histogram bin observation bin ++ length + observation bin length histogram length ++ learn histogram bin count histogram length histogram learn histogram bin count histogram length histogram start current milli partition length alpha k current digamma denominator sum 0 0 k k 0 k partition length k++ k magnitude partition k sum + k iteration 0 iteration 1000 iteration++ calculate denominator denominator 0 current digamma 0 1 length histogram length i++ current digamma + 1 sum + 1 denominator + length histogram current digamma denominator 0 0 na n denominator sum 0 0 calculate individual k 0 k partition length k++ alpha k k k 0 0 current digamma 0 histogram bin count histogram k histogram length 1 since histogram 0 0 k 0 000001 1 histogram length i++ current digamma + 1 alpha k + 1 k + histogram current digamma k 0 0 length empty + 0 length 0 histogram length i++ print histogram + k 0 0 na n k k alpha k denominator sum + k iteration % 25 0 sum newsgroup iteration + iteration iteration + + current milli start e e k 0 k partition length k++ partition k k sum magnitude sum magnitude partition current milli start fix point iteration describe tom minka learn digamma observation bin count partition length observation length get mem + current milli start observation length observation length get length + current milli start 0 observation length i++ observation observation bin 0 bin partition length bin++ bin count bin observation bin observation length + observation bin init + current milli start learn digamma bin count observation length learn digamma bin count observation length start current milli partition length alpha k denominator magnitude k iteration 0 iteration 1000 iteration++ magnitude 0 calculate denominator denominator 0 0 observation length length i++ denominator + digamma magnitude + observation length denominator observation length length digamma magnitude calculate individual k 0 k partition length k++ k 0 count bin count k alpha k magnitude partition k digamma alpha k digamma alpha k 0 count length i++ count 0 k + digamma alpha k k + digamma alpha k + count k count length digamma alpha k k 0 k 0 000001 k alpha k denominator k 0 k + + alpha k + + denominator k 0 na n k magnitude + k finish dimension + k magnitude magnitude k 0 k partition length k++ partition k k magnitude k 20 partition k + +new k + +magnitude iteration % 25 0 newsgroup digamma iteration + iteration iteration + + current milli start e e magnitude partition current milli start estimate dirichlet moment match describe ronn learn moment observation start current milli bin observation length observation length variance partition length fill partition 0 0 fill observation length 0 fill variance 0 0 find e p k 0 observation length i++ observation observation find sum count bin bin 0 bin partition length bin++ observation length + observation bin bin 0 bin partition length bin++ partition bin + observation bin observation length bin 0 bin partition length bin++ partition bin observation length find var p k difference 0 observation length i++ observation observation bin 0 bin partition length bin++ difference observation bin observation length partition bin variance bin + difference difference avoid math pow bin 0 bin partition length bin++ variance bin observation length 1 now calculate magnitude log \sum k \alpha k 1 k 1 \sum k log e p k 1 e p k var p k 1 sum 0 0 bin 0 bin partition length bin++ partition bin 0 sum + math log partition bin 1 partition bin variance bin 1 magnitude math sum partition length 1 magnitude partition current milli start learn leave observation bin count partition length observation length get mem + current milli start observation length observation length get length + current milli start 0 observation length i++ observation observation bin 0 bin partition length bin++ bin count bin observation bin observation length + observation bin init + current milli start learn leave bin count observation length learn minka leave l o o likelihood learn leave bin count observation length start current milli bin partition length bin sum partition length observation sum 0 0 parameter sum 0 0 count uniform initialization fill partition 1 0 partition length iteration 0 iteration 1000 iteration++ observation sum 0 0 fill bin sum 0 0 0 observation length length i++ observation sum + observation length observation length 1 + magnitude bin 0 bin partition length bin++ count bin count bin 0 count length i++ count 2 bin sum bin + count count 1 + magnitude partition bin parameter sum 0 0 bin 0 bin partition length bin++ bin sum bin 0 0 bin 0 000001 bin partition bin magnitude bin sum bin observation sum parameter sum + bin bin 0 bin partition length bin++ partition bin bin parameter sum magnitude parameter sum iteration % 50 0 iteration + + magnitude magnitude partition current milli start compute l1 residual between two dirichlet absolute difference dirichlet partition length partition length illegal argument dirichlet same dimension compare residual 0 0 k 0 k partition length k++ residual + math ab partition k magnitude partition k magnitude residual compute l2 residual between two dirichlet square difference dirichlet partition length partition length illegal argument dirichlet same dimension compare residual 0 0 k 0 k partition length k++ residual + math pow partition k magnitude partition k magnitude 2 residual check breakeven start clock1 clock2 digamma digamma n 1 n 100 n++ start current milli 0 1000000 i++ digamma + n clock1 current milli start start current milli 0 1000000 i++ digamma difference n clock2 current milli start n + + clock1 + + clock2 + + clock1 clock2 + + digamma + n digamma + + digamma difference n compare sum k n w dirichlet uniform dirichlet dirichlet buffer output buffer output append sum + + k + + n + + w + uniform dirichlet dirichlet k sum k dirichlet dirichlet sum uniform dirichlet next real + dirichlet magnitude dirichlet partition observation dirichlet draw observation n w drawing dirichlet estimate dirichlet dirichlet k sum k estimate dirichlet learn digamma observation output append + + dirichlet absolute difference estimate dirichlet + estimate dirichlet dirichlet k sum k estimate dirichlet learn histogram observation output append + + dirichlet absolute difference estimate dirichlet + estimate dirichlet dirichlet k sum k estimate dirichlet learn moment observation output append + + dirichlet absolute difference estimate dirichlet + moment + + + dirichlet absolute difference estimate dirichlet estimate dirichlet dirichlet k sum k estimate dirichlet learn leave observation output append + + dirichlet absolute difference estimate dirichlet + leave + + + dirichlet absolute difference estimate dirichlet output what probability these two observation be draw same multinomial symmetric dirichlet prior alpha relative probability they be draw different multinomial both draw dirichlet? dirichlet multinomial likelihood ratio t hash map count t hash map count y alpha alpha sum likelihood m gamma alpha sum prod gamma alpha + n prod gamma alpha gamma alpha sum + n we divide two m same alpha parameter first term numerator cancel first term denominator move remain alpha term numerator we get prod gamma alpha prod gamma alpha + + y gamma alpha sum gamma alpha sum + sum + y sum prod gamma alpha + prod gamma alpha + y gamma alpha sum + sum gamma alpha sum + y sum log likelihood 0 0 log gamma alpha log gamma alpha total 0 total y 0 key y t hash distinct key t hash distinct key add count key distinct key add count y key t iterator iterator distinct key iterator iterator next key iterator next 0 count contain key key count get key y 0 count y contain key key y count y get key total + total y + y log likelihood + log gamma alpha + log gamma alpha + + y log gamma alpha + log gamma alpha + y log likelihood + log gamma alpha sum + total + log gamma alpha sum + total y log gamma alpha sum log gamma alpha sum + total + total y log likelihood what probability these two observation be draw same multinomial symmetric dirichlet prior alpha relative probability they be draw different multinomial both draw dirichlet? dirichlet multinomial likelihood ratio count count y alpha alpha sum exactly same take trove hashmap fix size count length count y length illegal argument both contain same dimension log likelihood 0 0 log gamma alpha log gamma alpha total 0 total y 0 y key 0 key count length key++ count key y count y key total + total y + y log likelihood + log gamma alpha + log gamma alpha + + y log gamma alpha + log gamma alpha + y log likelihood + log gamma alpha sum + total + log gamma alpha sum + total y log gamma alpha sum log gamma alpha sum + total + total y log likelihood us symmetric dirichlet prior dirichlet multinomial likelihood ratio count count y count length count y length || count length partition length illegal argument both dirichlet prior contain same dimension log likelihood 0 0 alpha total 0 total y 0 y key 0 key count length key++ count key y count y key total + total y + y alpha partition key magnitude log likelihood + log gamma alpha + log gamma alpha + + y log gamma alpha + log gamma alpha + y log likelihood + log gamma magnitude + total + log gamma magnitude + total y log gamma magnitude log gamma magnitude + total + total y log likelihood similar dirichlet multinomial test likelihood ratio ewen sampling formula can consider partition generate chinese restaurant process ewen likelihood ratio count count y lambda count length count y length illegal argument both contain same dimension log likelihood 0 0 alpha total 0 total y 0 total 0 y first count up total key 0 key count length key++ count key y count y key total + total y + y total + + y now allocate some statisitic contain element count histogram total + 1 count histogram y total + 1 count histogram both total + 1 key 0 key count length key++ count key y count y key count histogram ++ count histogram y ++ count histogram both + y ++ j 1 j total j++ count histogram j 0 count histogram y j 0 count histogram both j 0 log likelihood + count histogram both j count histogram j count histogram y j math log lambda j log likelihood + log gamma count histogram j + 1 + log gamma count histogram y j + 1 log gamma count histogram both j + 1 log likelihood + log gamma total + 1 log gamma total + 1 log gamma total y + 1 log likelihood + log gamma lambda + total + log gamma lambda + total y log gamma lambda log gamma lambda + total + total y log likelihood run comparison precision dimension document size print writer print writer buffer writer writer comparison dimension 10 j 0 j 5 j++ document 100 k 0 k 5 k++ size 100 l 0 l 5 l++ dimension + + dimension + + document + + size run ten time m 0 m 10 m++ dir 1 1 1 1 now compare dimension dimension document size flush size 2 document 2 dimension 2 flush close e e print stack trace test symmetric concentration 1000 100 1000 dirichlet prior dirichlet 100 1 0 y 0 50 i++ dirichlet symmetric dirichlet 100 prior next two observation same multinomial symmetric next symmetric draw observation 100 y symmetric draw observation 100 print symmetric dirichlet multinomial likelihood ratio y + print ewen likelihood ratio y 1 + two observation different multinomial symmetric draw observation 100 y symmetric draw observation 100 print ewen likelihood ratio y 0 1 + symmetric dirichlet multinomial likelihood ratio y alphabet get alphabet dict size partition length alpha feature index magnitude partition feature index print dirichlet j 0 j partition length j++ dict ? dict lookup j j + + magnitude partition j random raw multinomial random r sum 0 pr partition length 0 partition length i++ alpha 0 j 0 j alpha length j++ dict lookup symbol j + + alpha j pr r next gamma magnitude partition sum + pr 0 partition length i++ pr sum pr multinomial random multinomial random r multinomial random raw multinomial r dict partition length dirichlet random dirichlet random r average alpha pr random raw multinomial r alpha sum pr length average alpha random dirichlet alpha sum +alpha sum 0 pr length i++ pr alpha sum dirichlet pr dict feature random feature random r length multinomial m random multinomial r m random feature r length feature vector random feature vector random r size feature vector random feature r size random random r length feature f random feature r length t length 0 length i++ t add f get position t random vector random r random raw multinomial r estimator multinomial multinomial estimator multinomial multinomial estimator collection multinomial multinomial training multinomial multinomial multinomial training 1 multinomial size i++ multinomial multinomial get 1 size multinomial multinomial get size || multinomial multinomial get 1 get alphabet multinomial multinomial get get alphabet illegal argument multinomial same size alphabet add multinomial multinomial m xxx size multinomial add m dirichlet estimate moment estimator estimator dirichlet estimate dim multinomial get 0 size alpha dim 1 multinomial size i++ multinomial get add probability alpha alpha sum 0 0 alpha length i++ alpha sum + alpha 0 alpha length i++ alpha alpha sum xxx fix sum variance match unsupport operation yet dirichlet alpha 