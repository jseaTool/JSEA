topic type io format logging hierarchical p m node g over topic next level additional node specific topic david mimno hierarchical p m logger logger logger get logger hierarchical p m get name command input command hierarchical p m input f l e n m e filename read training instance stdin + instance feature feature bigram feature vector command command hierarchical p m output f l e n m e filename write gibbs sampling iteration + indicate write command topic balance command hierarchical p m topic balance e m l 1 0 weight \ words\ share over topic relative document specific command sub topic balance command hierarchical p m sub topic balance e m l 1 0 weight \ words\ share over sub topic topic relative document specific command num topic command hierarchical p m num topic n t e g e r 10 topic command num sub topic command hierarchical p m num sub topic n t e g e r 20 sub topic n u m l e v e l 3 constant determine level output multinomial r o o t t o p 0 u p e r t o p 1 u t o p 2 num topic topic fit num sub topic parameter control balance between local document count global over topic topic balance 1 0 parameter smooth global topic smooth 1 0 same sub topic sub topic balance 1 0 sub topic smooth 1 0 prior topic multinomial over word beta beta sum instance instance instance expect hold feature num type num gibbs sampling these could we could encode both topic index document index index sub topic index document index index document variable sub count word sub count word weight component gibbs update depend topic sub weight component gibbs update depend sub topic sub weight unnormaliz sampling cumulative weight cache cumulative weight topic document frequency minimal path hierarchical dirichlet topic document frequency sub topic document frequency sum sum document frequency sum topic document frequency note last same topic document frequency cache prior topic prior weight sub topic prior weight word type variable type topic count index feature index topic index topic index topic index topic index topic index sub topic runtime runtime format formatt hierarchical p m topic sub topic topic balance sub topic balance formatt format get instance formatt maximum fraction digit 5 topic balance topic balance sub topic balance sub topic balance num topic topic num sub topic sub topic topic document frequency num topic + 1 sub topic document frequency num topic + 1 num sub topic + 1 sum topic document frequency num topic beta 0 01 we can t calculate beta sum until we know many word type runtime runtime get runtime estimate instance document instance testing num iteration show topic interval output model interval optimize interval output model filename random r instance document num type instance get alphabet size num doc instance size topic num doc sub topic num doc allocate several document cut down memory allocation garbage collection sub count num topic + 1 num sub topic + 1 count num topic + 1 weight num topic + 1 sub weight num sub topic sub weight num topic + 1 num sub topic + 1 cumulative weight num topic type topic count num type 1 + num topic + num sub topic topic 1 + num topic + num sub topic topic num topic + 1 sub topic num topic + 1 num sub topic + 1 beta sum beta num type start current milli max 0 initialize random assignment topic finish allocate topic topic sub topic seq len doc 0 doc num doc doc++ local topic num topic + 1 local sub topic num topic + 1 num sub topic + 1 feature f feature instance get doc get seq len f get length seq len max max seq len num + seq len topic doc seq len sub topic doc seq len randomly topic position 0 position seq len position++ random topic topic r next num topic random sub topic sub topic r next num sub topic level r next n u m l e v e l level r o o t t o p topic doc position num topic sub topic doc position num sub topic type topic count f get index position position 0 ++ topic 0 ++ topic num topic ++ sub topic num topic num sub topic ++ local topic num topic 0 topic document frequency num topic ++ sum document frequencies++ local topic num topic ++ level u p e r t o p topic doc position topic sub topic doc position num sub topic type topic count f get index position position 1 + topic ++ topic 1 + topic ++ topic topic ++ sub topic topic num sub topic ++ local topic topic 0 topic document frequency topic ++ sum document frequencies++ local topic topic ++ local sub topic topic num sub topic 0 sub topic document frequency topic num sub topic ++ sum topic document frequency topic ++ local sub topic topic num sub topic ++ topic doc position topic sub topic doc position sub topic type topic count f get index position position 1 + num topic + sub topic ++ topic 1 + num topic + sub topic ++ topic topic ++ sub topic topic sub topic ++ local topic topic 0 topic document frequency topic ++ sum document frequencies++ local topic topic ++ local sub topic topic sub topic 0 sub topic document frequency topic sub topic ++ sum topic document frequency topic ++ local sub topic topic sub topic ++ initialize cache prior topic prior weight num topic + 1 sub topic prior weight num topic num sub topic + 1 cache topic prior topic 0 topic num topic topic++ cache sub topic prior topic start sampler iteration 1 iteration num iteration iterations++ iteration start current milli loop over word corpus doc 0 doc topic length doc++ sample topic doc feature instance get doc get topic doc sub topic doc r show topic interval 0 iteration % show topic interval 0 logger info print top word 8 logger fine current milli iteration start + iteration % 10 0 logger info + iteration + l l + formatt format model log likelihood num cache topic prior topic 0 topic num topic topic++ topic prior weight topic topic document frequency topic + topic smooth sum document frequency + num topic + 1 topic smooth topic prior weight num topic topic document frequency num topic + topic smooth sum document frequency + num topic + 1 topic smooth cache sub topic prior topic document frequency sub topic document frequency topic sub topic 0 sub topic num sub topic sub topic++ sub topic prior weight topic sub topic document frequency sub topic + sub topic smooth sum topic document frequency topic + num sub topic + 1 sub topic smooth sub topic prior weight topic num sub topic document frequency num sub topic + sub topic smooth sum topic document frequency topic + num sub topic + 1 sub topic smooth sample topic doc feature doc topic index seq position sub topic random r start current milli current type topic count current sub count current sub weight word weight 1 + num topic + num sub topic type sub topic topic root weight current weight cumulative weight sample doc len doc get length fill count 0 t 0 t num topic t++ fill sub count t 0 populate topic count position 0 position doc len position++ sub count topic position sub topic position ++ count topic position ++ topic 0 topic num topic topic++ weight topic count topic + topic balance topic prior weight topic count topic + sub topic balance weight topic 0 0 iterate over position word document position 0 position doc len position++ type doc get index position position current type topic count type topic count type topic topic position sub topic sub topic position topic num topic current type topic count 0 topic 0 sub topic num sub topic current type topic count 1 + topic topic 1 + topic current type topic count 1 + num topic + sub topic topic 1 + num topic + sub topic count count topic sub count topic sub topic count topic 0 document frequency change decrement recalculate prior weight topic document frequency topic sum document frequency cache topic prior topic num topic sub count topic sub topic 0 sub topic document frequency topic sub topic sum topic document frequency topic cache sub topic prior topic topic topic sub topic topic sub topic update topic weight old topic weight topic count topic + topic balance topic prior weight topic count topic + sub topic balance build over sub topic pair 0 word weight length i++ word weight beta + current type topic count beta sum + topic word weight 0 fill cumulative weight 0 0 conditional probability sub pair proportional expression three part depend topic depend sub topic word type depend sub pair cumulative weight 0 0 topic 0 topic num topic topic++ current sub weight sub weight topic current sub count sub count topic current weight weight topic document frequency sub topic document frequency topic prior cache sub topic prior weight topic sub topic 0 sub topic num sub topic sub topic++ current sub weight sub topic current weight word weight 1 + num topic + sub topic current sub count sub topic + sub topic balance prior cache sub topic cumulative weight + current sub weight sub topic current sub weight num sub topic current weight word weight 1 + topic current sub count num sub topic + sub topic balance prior cache num sub topic cumulative weight + current sub weight num sub topic cumulative weight topic cumulative weight cumulative weight topic 0 0 root weight word weight 0 count num topic + topic balance topic prior weight num topic sample topic assignment sample r next uniform cumulative weight + root weight sample cumulative weight we pick root topic current type topic count 0 ++ topic 0 ++ topic num topic sub topic num sub topic go over row sum find topic topic 0 sample cumulative weight topic topic++ now read acros find sub topic current sub weight sub weight topic cumulative weight cumulative weight topic go over sub topic until weight l e sample note we re subtract weight same we them sub topic 0 cumulative weight current sub weight 0 sample cumulative weight sub topic++ cumulative weight current sub weight sub topic sub topic num sub topic current type topic count 1 + topic ++ topic 1 + topic ++ current type topic count 1 + num topic + sub topic ++ topic 1 + num topic + sub topic ++ save choice into gibbs topic position topic sub topic position sub topic put sub topic into count sub count topic sub topic ++ count topic ++ count topic 1 topic document frequency topic ++ sum document frequencies++ cache topic prior topic num topic sub count topic sub topic 1 sub topic document frequency topic sub topic ++ sum topic document frequency topic ++ cache sub topic prior topic topic topic ++ sub topic topic sub topic ++ update weight topic weight topic count topic + topic balance topic prior weight topic count topic + sub topic balance print top word num word line builder output builder sorter sort type sorter num type sorter sort sub topic sorter num sub topic topic 1 + num topic + num sub topic sub topic topic topic 0 topic topic length topic++ type 0 type num type type++ sort type type sorter type type topic count type topic topic topic sort sort type builder builder 0 num word i++ append instance get alphabet lookup sort type get append topic topic max sub topic 10 num sub topic 10 max sub topic num sub topic output append root + + topic num topic + + topic document frequency num topic + + topic 0 + topic 0 topic num topic topic++ sub topic 0 sub topic num sub topic sub topic++ sort sub topic sub topic sorter sub topic sub topic topic sub topic sort sort sub topic output append topic + topic + + topic topic + + topic document frequency topic + + sub topic topic num sub topic + + sub topic document frequency topic num sub topic + + topic 1 + topic + 0 max sub topic i++ sub topic sort sub topic get output append sub topic + + sub topic topic sub topic + + formatt format sub topic document frequency topic sub topic + + topic 1 + num topic + sub topic + output print f o print writer print writer buffer writer writer f print close print print writer alphabet alphabet instance get alphabet doc po typeindex type topic sub topic doc 0 doc topic length doc++ builder output builder feature f feature instance get doc get position 0 position topic doc length position++ type f get index position position output append doc output append output append position output append output append type output append output append alphabet lookup type output append output append topic doc position output append output append sub topic doc position output append print output model log likelihood log likelihood 0 0 zero topic likelihood model dirichlet multinomial word topic dirichlet multinomial topic document likelihood function dirichlet multinomial gamma sum alpha prod gamma alpha + n prod gamma alpha gamma sum alpha + n log likelihood log gamma sum alpha log gamma sum alpha + n + sum log gamma alpha + n log gamma alpha document first topic sub topic topic log gamma num topic + 1 sub topic log gamma num topic num sub topic + 1 topic 0 topic num topic topic++ topic log gamma topic dirichlet log gamma topic prior weight topic sub topic 0 sub topic num sub topic sub topic++ sub topic log gamma topic sub topic dirichlet log gamma sub topic balance sub topic prior weight topic sub topic sub topic log gamma topic num sub topic dirichlet log gamma sub topic balance sub topic prior weight topic num sub topic topic log gamma num topic dirichlet log gamma topic prior weight num topic topic count num topic + 1 sub topic count num topic num sub topic + 1 doc topic doc sub topic doc 0 doc topic length doc++ doc topic topic doc doc sub topic sub topic doc 0 doc topic length token++ topic doc topic sub topic doc sub topic topic count topic ++ topic num topic sub topic count topic sub topic ++ topic 0 topic num topic topic++ topic count topic 0 log likelihood + dirichlet log gamma topic balance topic prior weight topic + topic count topic topic log gamma topic sub topic 0 sub topic num sub topic sub topic++ sub topic count topic sub topic 0 log likelihood + dirichlet log gamma sub topic balance sub topic prior weight topic sub topic + sub topic count topic sub topic sub topic log gamma topic sub topic account word assign topic log likelihood + dirichlet log gamma sub topic balance sub topic prior weight topic num sub topic + sub topic count topic num sub topic sub topic log gamma topic num sub topic term sum log likelihood + dirichlet log gamma sub topic balance dirichlet log gamma sub topic balance + topic count topic fill sub topic count topic 0 account word assign root topic log likelihood + dirichlet log gamma topic balance topic prior weight num topic + topic count num topic topic log gamma num topic subtract count + parameter sum term log likelihood dirichlet log gamma topic balance + doc topic length fill topic count 0 add parameter sum term document once log likelihood + topic length dirichlet log gamma topic balance topic count type topic pair zero type topic 0 type 0 type num type type++ reuse pointer topic count type topic count type topic 0 topic num topic + num sub topic + 1 topic++ topic count topic 0 zero type topics++ log likelihood + dirichlet log gamma beta + topic count topic topic 0 topic num topic + num sub topic + 1 topic++ log likelihood dirichlet log gamma beta num topic + num sub topic + 1 + topic topic log likelihood + dirichlet log gamma beta num topic + num sub topic + 1 dirichlet log gamma beta zero type topic log likelihood o command summary hierarchical p m train three level hierarchy topic command process hierarchical p m instance instance instance load input value instance testing hierarchical p m pam hierarchical p m num topic value num sub topic value topic balance value sub topic balance value pam estimate instance testing 1000 100 0 250 random pam print value 