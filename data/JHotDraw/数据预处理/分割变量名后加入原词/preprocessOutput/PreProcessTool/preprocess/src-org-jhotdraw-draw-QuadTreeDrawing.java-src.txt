QuadTreeDrawing quad tree drawing java 2 2 0 0 2006 2006 01 01 14 14 Copyright copyright c c 1996 1996 2006 2006 by by the the original original authors author of of JHotDraw jhotdraw and and all all its it contributors contributor JHotDraw jhotdraw org org All all rights right reserved reserve This software software is is the the confidential confidential and and proprietary proprietary information information of of JHotDraw jhotdraw org org Confidential confidential Information information You you shall shall not not disclose disclose such such Confidential confidential Information information and and shall shall use use it it only only in in accordance accordance with with the the terms term of of the the license license agreement agreement you you entered enter into into with with JHotDraw jhotdraw org org ??? ??? package org org jhotdraw jhotdraw draw draw import org org jhotdraw jhotdraw geom geom QuadTree2DDouble quad tree2 d import org org jhotdraw jhotdraw util util ReversedList reverse list import java awt awt import java awt awt geom geom import javax javax swing swing import javax javax swing swing event event import org org jhotdraw jhotdraw util util import java util util QuadTreeDrawing quad tree drawing uses us a a QuadTree2DDouble quad tree2 d to to improve improve responsiveness responsiveness of of drawings drawing which which contain contain many many figures figure author author Werner wern Randelshofer randelshof version 2 2 0 0 2006 2006 01 01 14 14 Changed change to to support support double precision precision coordinates coordinate br 1 1 0 0 2003 2003 12 12 01 01 Derived derive from from JHotDraw jhotdraw 5 5 4b1 4b1 public class QuadTreeDrawing quad tree drawing extends AbstractDrawingimplements drawingimplement FigureListener figure listener UndoableEditListener undoable edit listener private ArrayList list Figure figure figures figure new ArrayList list Figure figure private QuadTree2DDouble quad tree2 d Figure figure quadTree quad tree new QuadTree2DDouble quad tree2 d Figure figure private boolean needsSorting need sorting false Creates create a a new instance instance public QuadTreeDrawing quad tree drawing protected int indexOf index of Figure figure figure figure return figures figure indexOf index of figure figure public void basicAdd basic add int index index Figure figure figure figure figures figure add add index index figure figure quadTree quad tree add add figure figure figure figure getDrawBounds get draw bound figure figure addFigureListener add figure listener this figure figure addUndoableEditListener add undoable edit listener this needsSorting need sorting true public void basicRemove basic remove Figure figure figure figure figures figure remove remove figure figure quadTree quad tree remove remove figure figure figure figure removeFigureListener remove figure listener this figure figure removeUndoableEditListener remove undoable edit listener this needsSorting need sorting true public void draw draw Graphics2D graphics2 d g g Collection collection Figure figure c c quadTree quad tree findIntersects find intersect g g getClipBounds get clip bound getBounds2D get bounds2 d Collection collection Figure figure toDraw to draw sort sort c c draw draw g g toDraw to draw Implementation note note Sorting sorting can can not not be be done for orphaned orphan figures figure public Collection collection Figure figure sort sort Collection collection Figure figure c c ensureSorted ensure sort ArrayList list Figure figure sorted sort new ArrayList list Figure figure c c size size for Figure figure f f figures figure if c c contains contain f f sorted sort add add f f return sorted sort public void draw draw Graphics2D graphics2 d g g Collection collection Figure figure c c for Figure figure f f c c f f draw draw g g public void figureAreaInvalidated figure area invalidate FigureEvent figure event e e fireAreaInvalidated fire area invalidate e e getInvalidatedArea get invalidate area public void figureChanged figure change FigureEvent figure event e e quadTree quad tree remove remove e e getFigure get figure quadTree quad tree add add e e getFigure get figure e e getFigure get figure getDrawBounds get draw bound needsSorting need sorting true fireAreaInvalidated fire area invalidate e e getInvalidatedArea get invalidate area public void figureAdded figure add FigureEvent figure event e e public void figureRemoved figure remove FigureEvent figure event e e public void figureRequestRemove figure request remove FigureEvent figure event e e remove remove e e getFigure get figure public Collection collection Figure figure getFigures get figure Rectangle2D rectangle2 d Double bounds bound return quadTree quad tree findInside find inside bounds bound public Collection collection Figure figure getFigures get figure return Collections collection unmodifiableCollection unmodifiable collection figures figure public Figure figure findFigureInside find figure inside Point2D point2 d Double p p Collection collection Figure figure c c quadTree quad tree findContains find contain p p for Figure figure f f getFiguresFrontToBack get figure front to back if c c contains contain f f f f contains contain p p return f f findFigureInside find figure inside p p return null Returns an an iterator iterator to to iterate iterate in in Z z order order front front to to back back over over the the figures figure public java util util List list Figure figure getFiguresFrontToBack get figure front to back ensureSorted ensure sort return new ReversedList reverse list Figure figure figures figure public Figure figure findFigure find figure Point2D point2 d Double p p Collection collection Figure figure c c quadTree quad tree findContains find contain p p switch c c size size case 0 0 return null case 1 1 Figure figure f f c c iterator iterator next next return f f contains contain p p ? ? f f null default for Figure figure f f getFiguresFrontToBack get figure front to back if c c contains contain f f f f contains contain p p return f f return null public Figure figure findFigureExcept find figure except Point2D point2 d Double p p Figure figure ignore ignore Collection collection Figure figure c c quadTree quad tree findContains find contain p p switch c c size size case 0 0 return null case 1 1 Figure figure f f c c iterator iterator next next return f f ignore ignore || || f f contains contain p p ? ? null f f default for Figure figure f f getFiguresFrontToBack get figure front to back if f f ignore ignore f f contains contain p p return f f return null public Figure figure findFigureExcept find figure except Point2D point2 d Double p p Collection collection ignore ignore Collection collection Figure figure c c quadTree quad tree findContains find contain p p switch c c size size case 0 0 return null case 1 1 Figure figure f f c c iterator iterator next next return ignore ignore contains contain f f || || f f contains contain p p ? ? null f f default for Figure figure f f getFiguresFrontToBack get figure front to back if ignore ignore contains contain f f f f contains contain p p return f f return null public Collection collection Figure figure findFigures find figure Rectangle2D rectangle2 d Double r r Collection collection Figure figure c c quadTree quad tree findIntersects find intersect r r switch c c size size case 0 0 fall fall through through case 1 1 return c c default return sort sort c c public Collection collection Figure figure findFiguresWithin find figure within Rectangle2D rectangle2 d Double r r Collection collection Figure figure c c findFigures find figure r r ArrayList list Figure figure result result new ArrayList list Figure figure c c size size for Figure figure f f c c if r r contains contain f f getBounds get bound result result add add f f return result result public void bringToFront bring to front Figure figure figure figure if figures figure remove remove figure figure figures figure add add figure figure needsSorting need sorting true fireAreaInvalidated fire area invalidate figure figure getDrawBounds get draw bound public void sendToBack send to back Figure figure figure figure if figures figure remove remove figure figure figures figure add add 0 0 figure figure needsSorting need sorting true fireAreaInvalidated fire area invalidate figure figure getDrawBounds get draw bound We we propagate propagate all all edit edit events event from from our our figures figure to to undoable undoable edit edit listeners listener which which have have registered register with with us u public void undoableEditHappened undoable edit happen UndoableEditEvent undoable edit event e e fireUndoableEditHappened fire undoable edit happen e e getEdit get edit public void figureAttributeChanged figure attribute change FigureEvent figure event e e public boolean contains contain Figure figure f f return figures figure contains contain f f Ensures ensure that that the the figures figure are are sorted sort in in z z order order sequence sequence private void ensureSorted ensure sort if needsSorting need sorting Collections collection sort sort figures figure FigureLayerComparator figure layer comparator INSTANCE i n s t a n c e needsSorting need sorting false 