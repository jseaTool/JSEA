StdXMLParser std xml parser java NanoXML nano xml Java $Revision $ revision 1 1 5 5 $ $ $Date $ date 2002 2002 03 03 24 24 11 11 37 37 00 00 $ $ $Name $ name RELEASE r e l e a s e 2 2 2 2 1 1 $ $ This file is is part part of of NanoXML nano xml 2 2 for Java Copyright copyright C c 2000 2000 2002 2002 Marc marc De de Scheemaecker scheemaeck All all Rights right Reserved reserve This software software is is provided provide as a is is without without any any express express or or implied imply warranty warranty In in no no event event will will the the authors author be be held hold liable liable for any any damages damage arising arise from from the the use use of of this software software Permission permission is is granted grant to to anyone anyone to to use use this software software for any any purpose purpose including include commercial commercial applications application and and to to alter alter it it and and redistribute redistribute it it freely freely subject subject to to the the following following restrictions restriction 1 1 The the origin origin of of this software software must must not not be be misrepresented misrepresent you you must must not not claim claim that that you you wrote write the the original original software software If you you use use this software software in in a a product product an an acknowledgment acknowledgment in in the the product product documentation documentation would would be be appreciated appreciate but but is is not not required require 2 2 Altered alter source source versions must must be be plainly plainly marked mark as a such such and and must must not not be be misrepresented misrepresent as a being being the the original original software software 3 3 This notice notice may may not not be be removed remove or or altered alter from from any any source source distribution distribution package net net n3 n3 nanoxml nanoxml import java io io IOException i o import java io io CharArrayReader reader import java io io Reader reader import java util util Enumeration enumeration import java util util Properties property import java util util Vector vector StdXMLParser std xml parser is is the the core core parser parser of of NanoXML nano xml author author Marc marc De de Scheemaecker scheemaeck version $Name $ name RELEASE r e l e a s e 2 2 2 2 1 1 $ $ $Revision $ revision 1 1 5 5 $ $ public class StdXMLParser std xml parser implements IXMLParser i xml parser The the builder builder which which creates create the the logical logical structure structure of of the the XML xml data data private IXMLBuilder i xml builder builder builder The the reader reader from from which which the the parser parser retrieves retrieve its it data data private IXMLReader i xml reader reader reader The the entity entity resolver resolv private IXMLEntityResolver i xml entity resolv entityResolver entity resolv The the validator validator that that will will process process entity entity references reference and and validate validate the the XML xml data data private IXMLValidator i xml validator validator validator Creates create a a new parser parser public StdXMLParser std xml parser this builder builder null this validator validator null this reader reader null this entityResolver entity resolv new XMLEntityResolver xml entity resolv Cleans clean up up the the object when when it it s s destroyed destroy protected void finalize finalize throws Throwable throwable this builder builder null this reader reader null this entityResolver entity resolv null this validator validator null super finalize finalize Sets set the the builder builder which which creates create the the logical logical structure structure of of the the XML xml data data param builder builder the the non non null builder builder public void setBuilder set builder IXMLBuilder i xml builder builder builder this builder builder builder builder Returns the the builder builder which which creates create the the logical logical structure structure of of the the XML xml data data return the the builder builder public IXMLBuilder i xml builder getBuilder get builder return this builder builder Sets set the the validator validator that that validates validate the the XML xml data data param validator validator the the non non null validator validator public void setValidator set validator IXMLValidator i xml validator validator validator this validator validator validator validator Returns the the validator validator that that validates validate the the XML xml data data return the the validator validator public IXMLValidator i xml validator getValidator get validator return this validator validator Sets set the the entity entity resolver resolv param resolver resolv the the non non null resolver resolv public void setResolver set resolv IXMLEntityResolver i xml entity resolv resolver resolv this entityResolver entity resolv resolver resolv Returns the the entity entity resolver resolv return the the non non null resolver resolv public IXMLEntityResolver i xml entity resolv getResolver get resolv return this entityResolver entity resolv Sets set the the reader reader from from which which the the parser parser retrieves retrieve its it data data param reader reader the the reader reader public void setReader set reader IXMLReader i xml reader reader reader this reader reader reader reader Returns the the reader reader from from which which the the parser parser retrieves retrieve its it data data return the the reader reader public IXMLReader i xml reader getReader get reader return this reader reader Parses pars the the data data and and lets let the the builder builder create create the the logical logical data data structure structure return the the logical logical structure structure built build by by the the builder builder throws net net n3 n3 nanoxml nanoxml XMLException xml if an an error occurred occur reading reading or or parsing parse the the data data public Object parse parse throws XMLException xml try this builder builder startBuilding start building this reader reader getSystemID get this reader reader getLineNr get line nr this scanData scan data return this builder builder getResult get result catch XMLException xml e e throw e e catch Exception e e XMLException xml error new XMLException xml e e error initCause init cause e e throw error throw new XMLException xml e e Scans scan the the XML xml data data for elements element throws java lang lang Exception if something someth went go wrong wrong protected void scanData scan data throws Exception while this reader reader atEOF at e o f this builder builder getResult get result null String str str XMLUtil xml util read read this reader reader char ch ch str str charAt at 0 0 if ch ch XMLUtil xml util processEntity process entity str str this reader reader this entityResolver entity resolv continue switch ch ch case this scanSomeTag scan some tag false don t t allow allow CDATA c d a t a null no no default namespace namespace new Properties property break case case case \r \r case skip skip whitespace whitespace break default XMLUtil xml util errorInvalidInput invalid input reader reader getSystemID get reader reader getLineNr get line nr ` ` + + ch ch + + 0x 0x + + Integer toHexString to hex int ch ch + + Scans scan an an XML xml tag tag param allowCDATA allow c d a t a true if CDATA c d a t a sections section are are allowed allow at at this point point param defaultNamespace namespace the the default namespace namespace URI u r i or or null param namespaces namespace list list of of defined define namespaces namespace throws java lang lang Exception if something someth went go wrong wrong protected void scanSomeTag scan some tag boolean allowCDATA allow c d a t a String defaultNamespace namespace Properties property namespaces namespace throws Exception String str str XMLUtil xml util read read this reader reader char ch ch str str charAt at 0 0 if ch ch XMLUtil xml util errorUnexpectedEntity unexpect entity reader reader getSystemID get reader reader getLineNr get line nr str str switch ch ch case ? ? this processPI process p i break case this processSpecialTag process special tag allowCDATA allow c d a t a break default this reader reader unread unread ch ch this processElement process element defaultNamespace namespace namespaces namespace Processes process a a processing processing instruction instruction throws java lang lang Exception if something someth went go wrong wrong protected void processPI process p i throws Exception XMLUtil xml util skipWhitespace skip whitespace this reader reader null String target target XMLUtil xml util scanIdentifier scan identifier this reader reader XMLUtil xml util skipWhitespace skip whitespace this reader reader null Reader reader reader reader new PIReader p i reader this reader reader if target target equalsIgnoreCase equal ignore xml xml this builder builder newProcessingInstruction processing instruction target target reader reader reader reader close close Processes process a a tag tag that that starts start with with a a bang bang lt lt gt param allowCDATA allow c d a t a true if CDATA c d a t a sections section are are allowed allow at at this point point throws java lang lang Exception if something someth went go wrong wrong protected void processSpecialTag process special tag boolean allowCDATA allow c d a t a throws Exception String str str XMLUtil xml util read read this reader reader char ch ch str str charAt at 0 0 if ch ch XMLUtil xml util errorUnexpectedEntity unexpect entity reader reader getSystemID get reader reader getLineNr get line nr str str switch ch ch case if allowCDATA allow c d a t a this processCDATA process c d a t a else XMLUtil xml util errorUnexpectedCDATA unexpect c d a t a reader reader getSystemID get reader reader getLineNr get line nr return case D d this processDocType process doc type return case XMLUtil xml util skipComment skip comment this reader reader return Processes process a a CDATA c d a t a section section throws java lang lang Exception if something someth went go wrong wrong protected void processCDATA process c d a t a throws Exception if XMLUtil xml util checkLiteral check literal this reader reader CDATA c d a t a XMLUtil xml util errorExpectedInput expect input reader reader getSystemID get reader reader getLineNr get line nr CDATA c d a t a this validator validator PCDataAdded p c data add this reader reader getSystemID get this reader reader getLineNr get line nr Reader reader reader reader new CDATAReader c d a t a reader this reader reader this builder builder addPCData add p c data reader reader this reader reader getSystemID get this reader reader getLineNr get line nr reader reader close close Processes process a a document document type type declaration declaration throws java lang lang Exception if an an error occurred occur reading reading or or parsing parse the the data data protected void processDocType process doc type throws Exception if XMLUtil xml util checkLiteral check literal this reader reader OCTYPE o c t y p e XMLUtil xml util errorExpectedInput expect input reader reader getSystemID get reader reader getLineNr get line nr DOCTYPE d o c t y p e return XMLUtil xml util skipWhitespace skip whitespace this reader reader null String systemID null StringBuffer buffer publicID new StringBuffer buffer String rootElement root element XMLUtil xml util scanIdentifier scan identifier this reader reader XMLUtil xml util skipWhitespace skip whitespace this reader reader null char ch ch this reader reader read read if ch ch P p systemID XMLUtil xml util scanPublicID scan publicID reader reader XMLUtil xml util skipWhitespace skip whitespace this reader reader null ch ch this reader reader read read else if ch ch S s systemID XMLUtil xml util scanSystemID scan reader reader XMLUtil xml util skipWhitespace skip whitespace this reader reader null ch ch this reader reader read read if ch ch this validator validator parseDTD parse d t d publicID toString to this reader reader this entityResolver entity resolv false XMLUtil xml util skipWhitespace skip whitespace this reader reader null ch ch this reader reader read read if ch ch XMLUtil xml util errorExpectedInput expect input reader reader getSystemID get reader reader getLineNr get line nr ` ` BEGIN b e g i n PATCH p a t c h W w Randelshofer randelshof Don t t read read DTD d t d if false if systemID null Reader reader reader reader this reader reader openStream open stream publicID toString to systemID this reader reader startNewStream start stream reader reader this reader reader setSystemID set systemID this reader reader setPublicID set publicID toString to this validator validator parseDTD parse d t d publicID toString to this reader reader this entityResolver entity resolv true END e n d PATCH p a t c h W w Randelshofer randelshof Don t t read read DTD d t d Processes process a a regular regular element element param defaultNamespace namespace the the default namespace namespace URI u r i or or null param namespaces namespace list list of of defined define namespaces namespace throws java lang lang Exception if something someth went go wrong wrong protected void processElement process element String defaultNamespace namespace Properties property namespaces namespace throws Exception String fullName full name XMLUtil xml util scanIdentifier scan identifier this reader reader String name name fullName full name XMLUtil xml util skipWhitespace skip whitespace this reader reader null String prefix prefix null int colonIndex colon index name name indexOf index of if colonIndex colon index 0 0 prefix prefix name name substring substring 0 0 colonIndex colon index name name name name substring substring colonIndex colon index + + 1 1 Vector vector attrNames attr name new Vector vector Vector vector attrValues attr value new Vector vector Vector vector attrTypes attr type new Vector vector this validator validator elementStarted element start fullName full name this reader reader getSystemID get this reader reader getLineNr get line nr char ch ch for ch ch this reader reader read read if ch ch || || ch ch break this reader reader unread unread ch ch this processAttribute process attribute attrNames attr name attrValues attr value attrTypes attr type XMLUtil xml util skipWhitespace skip whitespace this reader reader null Properties property extraAttributes extra attribute new Properties property this validator validator elementAttributesProcessed element attribute process fullName full name extraAttributes extra attribute this reader reader getSystemID get this reader reader getLineNr get line nr Enumeration enumeration enm enm extraAttributes extra attribute keys key while enm enm hasMoreElements ha more element String key key String enm enm nextElement next element String value value extraAttributes extra attribute getProperty get property key key attrNames attr name addElement add element key key attrValues attr value addElement add element value value attrTypes attr type addElement add element CDATA c d a t a for int i i 0 0 i i attrNames attr name size size i++ i++ String key key String attrNames attr name elementAt element at i i String value value String attrValues attr value elementAt element at i i String type type String attrTypes attr type elementAt element at i i if key key equals equal xmlns xmln defaultNamespace namespace value value else if key key startsWith start with xmlns xmln namespaces namespace put put key key substring substring 6 6 value value if prefix prefix null this builder builder startElement start element name name prefix prefix defaultNamespace namespace this reader reader getSystemID get this reader reader getLineNr get line nr else this builder builder startElement start element name name prefix prefix namespaces namespace getProperty get property prefix prefix this reader reader getSystemID get this reader reader getLineNr get line nr for int i i 0 0 i i attrNames attr name size size i++ i++ String key key String attrNames attr name elementAt element at i i if key key startsWith start with xmlns xmln continue String value value String attrValues attr value elementAt element at i i String type type String attrTypes attr type elementAt element at i i colonIndex colon index key key indexOf index of if colonIndex colon index 0 0 String attPrefix att prefix key key substring substring 0 0 colonIndex colon index key key key key substring substring colonIndex colon index + + 1 1 this builder builder addAttribute add attribute key key attPrefix att prefix namespaces namespace getProperty get property attPrefix att prefix value value type type else this builder builder addAttribute add attribute key key null null value value type type if prefix prefix null this builder builder elementAttributesProcessed element attribute process name name prefix prefix defaultNamespace namespace else this builder builder elementAttributesProcessed element attribute process name name prefix prefix namespaces namespace getProperty get property prefix prefix if ch ch if this reader reader read read XMLUtil xml util errorExpectedInput expect input reader reader getSystemID get reader reader getLineNr get line nr ` ` this validator validator elementEnded element end name name this reader reader getSystemID get this reader reader getLineNr get line nr if prefix prefix null this builder builder endElement end element name name prefix prefix defaultNamespace namespace else this builder builder endElement end element name name prefix prefix namespaces namespace getProperty get property prefix prefix return StringBuffer buffer buffer buffer new StringBuffer buffer 16 16 for buffer buffer setLength set length 0 0 String str str for XMLUtil xml util skipWhitespace skip whitespace this reader reader buffer buffer str str XMLUtil xml util read read this reader reader if str str charAt at 0 0 str str charAt at 1 1 XMLUtil xml util processEntity process entity str str this reader reader this entityResolver entity resolv else break if str str charAt at 0 0 str str XMLUtil xml util read read this reader reader \0 \0 if str str charAt at 0 0 XMLUtil xml util skipWhitespace skip whitespace this reader reader null str str XMLUtil xml util scanIdentifier scan identifier this reader reader if str str equals equal fullName full name XMLUtil xml util errorWrongClosingTag wrong closing tag reader reader getSystemID get reader reader getLineNr get line nr name name str str XMLUtil xml util skipWhitespace skip whitespace this reader reader null if this reader reader read read XMLUtil xml util errorClosingTagNotEmpty closing tag not empty reader reader getSystemID get reader reader getLineNr get line nr this validator validator elementEnded element end fullName full name this reader reader getSystemID get this reader reader getLineNr get line nr if prefix prefix null this builder builder endElement end element name name prefix prefix defaultNamespace namespace else this builder builder endElement end element name name prefix prefix namespaces namespace getProperty get property prefix prefix break else ^ ^ this reader reader unread unread str str charAt at 0 0 this scanSomeTag scan some tag true CDATA c d a t a allowed allow defaultNamespace namespace Properties property namespaces namespace clone clone else ^ ^ if str str charAt at 0 0 ch ch XMLUtil xml util processCharLiteral process literal str str buffer buffer append append ch ch else reader reader unread unread str str charAt at 0 0 this validator validator PCDataAdded p c data add this reader reader getSystemID get this reader reader getLineNr get line nr Reader reader r r new ContentReader content reader this reader reader this entityResolver entity resolv buffer buffer toString to this builder builder addPCData add p c data r r this reader reader getSystemID get this reader reader getLineNr get line nr r r close close Processes process an an attribute attribute of of an an element element param attrNames attr name contains contain the the names name of of the the attributes attribute param attrValues attr value contains contain the the values value of of the the attributes attribute param attrTypes attr type contains contain the the types type of of the the attributes attribute throws java lang lang Exception if something someth went go wrong wrong protected void processAttribute process attribute Vector vector attrNames attr name Vector vector attrValues attr value Vector vector attrTypes attr type throws Exception String key key XMLUtil xml util scanIdentifier scan identifier this reader reader XMLUtil xml util skipWhitespace skip whitespace this reader reader null if XMLUtil xml util read read this reader reader equals equal XMLUtil xml util errorExpectedInput expect input reader reader getSystemID get reader reader getLineNr get line nr ` ` XMLUtil xml util skipWhitespace skip whitespace this reader reader null String value value XMLUtil xml util scanString scan this reader reader this entityResolver entity resolv attrNames attr name addElement add element key key attrValues attr value addElement add element value value attrTypes attr type addElement add element CDATA c d a t a this validator validator attributeAdded attribute add key key value value this reader reader getSystemID get this reader reader getLineNr get line nr 