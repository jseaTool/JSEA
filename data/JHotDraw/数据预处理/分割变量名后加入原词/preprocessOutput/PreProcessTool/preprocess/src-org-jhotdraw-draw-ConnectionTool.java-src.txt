ConnectionTool connection tool java 3 3 1 1 2006 2006 07 07 15 15 Copyright copyright c c 1996 1996 2006 2006 by by the the original original authors author of of JHotDraw jhotdraw and and all all its it contributors contributor JHotDraw jhotdraw org org All all rights right reserved reserve This software software is is the the confidential confidential and and proprietary proprietary information information of of JHotDraw jhotdraw org org Confidential confidential Information information You you shall shall not not disclose disclose such such Confidential confidential Information information and and shall shall use use it it only only in in accordance accordance with with the the terms term of of the the license license agreement agreement you you entered enter into into with with JHotDraw jhotdraw org org ??? ??? package org org jhotdraw jhotdraw draw draw import org org jhotdraw jhotdraw undo undo import org org jhotdraw jhotdraw util util import java awt awt import java awt awt geom geom import java awt awt event event import java util util import java awt awt dnd dnd A a tool tool that that can can be be used use to to connect connect figures figure to to split split connections connection and and to to join join two two segments segment of of a a connection connection ConnectionTools connection tool turns turn the the visibility visibility of of the the Connectors connector on on when when it it enters enter a a figure figure The the connection connection object to to be be created create is is specified specify by by a a prototype prototype p p FIXME f i x m e Use use a a Tracker tracker instance instance for each each state state of of this tool tool author author Werner wern Randelshofer randelshof version 3 3 1 1 2006 2006 07 07 15 15 Added add support support for prototype prototype class name name br 3 3 0 0 2006 2006 06 06 07 07 Reworked rework br 2 2 1 1 2006 2006 03 03 15 15 When when user user is is not not pressing pressing the the mouse mouse button button we we use use the the mouse mouse over over view view as a the the current current view view br 2 2 0 0 1 1 2006 2006 02 02 14 14 Fixed fix drawing drawing code br 2 2 0 0 2006 2006 01 01 14 14 Changed change to to support support double precision precision coordinates coordinate br 1 1 0 0 2003 2003 12 12 01 01 Derived derive from from JHotDraw jhotdraw 5 5 4b1 4b1 public class ConnectionTool connection tool extends AbstractTool tool implements FigureListener figure listener private Map map AttributeKey attribute key Object attributes attribute the the anchor anchor point point of of the the interaction interaction private Connector connector startConnector start connector private Connector connector endConnector end connector private Connector connector targetConnector target connector private Figure figure target target the the currently currently created create figure figure private ConnectionFigure connection figure connection connection the the currently currently manipulated manipulate connection connection point point private int splitPoint split point the the currently currently edited edit connection connection private ConnectionFigure connection figure editedConnection edit connection the the figure figure that that was wa actually actually added add Note note this can can be be a a different different figure figure from from the the one one which which has ha been be created create private Figure figure createdFigure create figure the the prototypical prototypical figure figure that that is is used use to to create create new connections connection protected ConnectionFigure connection figure prototype prototype protected boolean isPressed is press Creates create a a new instance instance public ConnectionTool connection tool ConnectionFigure connection figure prototype prototype this prototype prototype prototype prototype public ConnectionTool connection tool ConnectionFigure connection figure prototype prototype Map map attributes attribute this prototype prototype prototype prototype this attributes attribute attributes attribute public ConnectionTool connection tool String prototypeClassName prototype name this prototypeClassName prototype name null public ConnectionTool connection tool String prototypeClassName prototype name Map map AttributeKey attribute key Object attributes attribute try this prototype prototype ConnectionFigure connection figure Class forName name prototypeClassName prototype name newInstance instance catch Exception e e InternalError internal error new InternalError internal Unable unable to to create create ConnectionFigure connection figure from from +prototypeClassName +prototype name error initCause init cause e e throw error this attributes attribute attributes attribute public ConnectionFigure connection figure getPrototype get prototype return prototype prototype public void mouseMoved mouse move MouseEvent mouse event evt evt trackConnectors track connector evt evt Manipulates manipulate connections connection in in a a context context dependent dependent way way If the the mouse mouse down down hits hit a a figure figure start start a a new connection connection If the the mousedown mousedown hits hit a a connection connection split split a a segment segment or or join join two two segments segment public void mousePressed mouse press MouseEvent mouse event evt evt super mousePressed mouse press evt evt isPressed is press true getView get view clearSelection clear selection Point2D point2 d Double ap ap viewToDrawing view to drawing anchor anchor if getTargetFigure get target figure null getTargetFigure get target figure setConnectorsVisible set connector visible false null setTargetFigure set target figure findConnectionStart find connection start ap ap getDrawing get drawing if getTargetFigure get target figure null setStartConnector set start connector findConnector find connector ap ap target target prototype prototype if getStartConnector get start connector null canConnect can connect getTargetFigure get target figure Point2D point2 d Double p p getStartConnector get start connector getAnchor get anchor setConnection set connection createFigure create figure getConnection get connection basicSetBounds basic set bound p p p p getConnection get connection addFigureListener add figure listener this setCreatedFigure set create figure getConnection get connection Adjust adjust the the created create connection connection or or split split segment segment public void mouseDragged mouse drag java awt awt event event MouseEvent mouse event e e Point2D point2 d Double p p viewToDrawing view to drawing new Point point e e getX get x e e getY get y if getConnection get connection null trackConnectors track connector e e if getTargetConnector get target connector null p p getTargetConnector get target connector getAnchor get anchor ConnectionFigure connection figure f f getConnection get connection fireAreaInvalidated fire area invalidate f f getDrawBounds get draw bound f f willChange will change f f basicSetBounds basic set bound f f getStartPoint get start point p p f f changed change fireAreaInvalidated fire area invalidate f f getDrawBounds get draw bound new Rectangle2D rectangle2 d Double viewToDrawing view to drawing anchor anchor p p else if editedConnection edit connection null editedConnection edit connection willChange will change editedConnection edit connection setPoint set point splitPoint split point p p editedConnection edit connection changed change protected boolean canConnect can connect Figure figure start start return prototype prototype canConnect can connect start start protected boolean canConnect can connect Figure figure start start Figure figure end end return prototype prototype canConnect can connect start start end end Connects connect the the figures figure if the the mouse mouse is is released release over over another another figure figure public void mouseReleased mouse release MouseEvent mouse event e e isPressed is press false isWorking is working false Figure figure c c null Point2D point2 d Double p p viewToDrawing view to drawing new Point point e e getX get x e e getY get y if getStartConnector get start connector null c c findTarget find target p p getDrawing get drawing if c c null setEndConnector set end connector findConnector find connector p p c c prototype prototype if getEndConnector get end connector null CompositeEdit composite edit creationEdit creation edit new CompositeEdit composite edit Verbindung verbindung erstellen erstellen getDrawing get drawing fireUndoableEditHappened fire undoable edit happen creationEdit creation edit ConnectionFigure connection figure f f getConnection get connection f f willChange will change f f setStartConnector set start connector getStartConnector get start connector f f setEndConnector set end connector getEndConnector get end connector f f basicSetBounds basic set bound f f getStartPoint get start point p p f f updateConnection update connection f f changed change f f removeFigureListener remove figure listener this getDrawing get drawing add add f f getDrawing get drawing fireUndoableEditHappened fire undoable edit happen creationEdit creation edit else if getConnection get connection null getDrawing get drawing remove remove getConnection get connection setConnection set connection null setStartConnector set start connector null setEndConnector set end connector null setCreatedFigure set create figure null fireToolDone fire tool public void activate activate DrawingEditor drawing editor editor editor super activate activate editor editor getView get view clearSelection clear selection public void deactivate deactivate DrawingEditor drawing editor editor editor super deactivate deactivate editor editor if getTargetFigure get target figure null getTargetFigure get target figure setConnectorsVisible set connector visible false null Creates create the the ConnectionFigure connection figure By by default the the figure figure prototype prototype is is cloned clone protected ConnectionFigure connection figure createFigure create figure ConnectionFigure connection figure f f ConnectionFigure connection figure prototype prototype clone clone getEditor get editor applyDefaultAttributesTo apply attribute to f f if attributes attribute null for Map map Entry entry AttributeKey attribute key Object entry entry attributes attribute entrySet entry set f f setAttribute set attribute AttributeKey attribute key entry entry getKey get key entry entry getValue get value return f f Finds find a a connectable connectable figure figure target target protected Figure figure findSource find source Point2D point2 d Double p p Drawing drawing drawing drawing return findConnectableFigure find connectable figure p p drawing drawing Finds find a a connectable connectable figure figure target target protected Figure figure findTarget find target Point2D point2 d Double p p Drawing drawing drawing drawing Figure figure target target findConnectableFigure find connectable figure p p drawing drawing Figure figure start start getStartConnector get start connector getOwner get owner if target target null getConnection get connection null canConnect can connect target target target target includes include start start canConnect can connect start start target target return target target return null Finds find an an existing connection connection figure figure protected ConnectionFigure connection figure findConnection find connection Point2D point2 d Double p p Drawing drawing drawing drawing for Figure figure f f drawing drawing getFiguresFrontToBack get figure front to back if f f null f f instanceof ConnectionFigure connection figure return ConnectionFigure connection figure f f return null protected void setConnection set connection ConnectionFigure connection figure newConnection connection connection connection newConnection connection Gets get the the connection connection which which is is created create by by this tool tool protected ConnectionFigure connection figure getConnection get connection return connection connection protected void trackConnectors track connector MouseEvent mouse event e e Point2D point2 d Double p p viewToDrawing view to drawing new Point point e e getX get x e e getY get y Figure figure c c null if getStartConnector get start connector null c c findSource find source p p getDrawing get drawing else c c findTarget find target p p getDrawing get drawing track track the the figure figure containing contain the the mouse mouse if c c getTargetFigure get target figure if getTargetFigure get target figure null getTargetFigure get target figure setConnectorsVisible set connector visible false null setTargetFigure set target figure c c if getStartConnector get start connector null if getTargetFigure get target figure null canConnect can connect getStartConnector get start connector getOwner get owner getTargetFigure get target figure getTargetFigure get target figure setConnectorsVisible set connector visible true getConnection get connection else if getTargetFigure get target figure null canConnect can connect getTargetFigure get target figure getTargetFigure get target figure setConnectorsVisible set connector visible true getConnection get connection Connector connector cc cc null if c c null cc cc findConnector find connector p p c c prototype prototype if cc cc getTargetConnector get target connector setTargetConnector set target connector cc cc view view checkDamage check damage public void draw draw Graphics2D graphics2 d g g if createdFigure create figure null Graphics2D graphics2 d gg gg Graphics2D graphics2 d g g create create gg gg transform transform getView get view getDrawingToViewTransform get drawing to view transform createdFigure create figure draw draw gg gg gg gg dispose dispose protected Connector connector findConnector find connector Point2D point2 d Double p p Figure figure target target ConnectionFigure connection figure f f return target target findConnector find connector p p f f Finds find a a connection connection start start figure figure protected Figure figure findConnectionStart find connection start Point2D point2 d Double p p Drawing drawing drawing drawing Figure figure target target findConnectableFigure find connectable figure p p drawing drawing if target target null target target canConnect can connect return target target return null protected Figure figure findConnectableFigure find connectable figure Point2D point2 d Double p p Drawing drawing drawing drawing return drawing drawing findFigureExcept find figure except p p createdFigure create figure protected void setStartConnector set start connector Connector connector newStartConnector start connector startConnector start connector newStartConnector start connector protected Connector connector getStartConnector get start connector return startConnector start connector protected void setEndConnector set end connector Connector connector newEndConnector end connector endConnector end connector newEndConnector end connector protected Connector connector getEndConnector get end connector return endConnector end connector private void setTargetConnector set target connector Connector connector newTargetConnector target connector targetConnector target connector newTargetConnector target connector protected Connector connector getTargetConnector get target connector return targetConnector target connector private void setTargetFigure set target figure Figure figure newTarget target target target newTarget target protected Figure figure getTargetFigure get target figure return target target Gets get the the figure figure that that was wa actually actually added add Note note this can can be be a a different different figure figure from from the the one one which which has ha been be created create protected Figure figure getCreatedFigure get create figure return createdFigure create figure protected void setCreatedFigure set create figure Figure figure newCreatedFigure create figure createdFigure create figure newCreatedFigure create figure public void figureAreaInvalidated figure area invalidate FigureEvent figure event evt evt fireAreaInvalidated fire area invalidate evt evt getInvalidatedArea get invalidate area public void figureAdded figure add FigureEvent figure event e e public void figureChanged figure change FigureEvent figure event e e public void figureRemoved figure remove FigureEvent figure event e e public void figureRequestRemove figure request remove FigureEvent figure event e e public void figureAttributeChanged figure attribute change FigureEvent figure event e e 